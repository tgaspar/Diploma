% -*- TeX:SI -*-
% slovene sub-mode for spell check

\documentclass[a4paper,twoside,openright,12pt]{book}
\usepackage[cp1250]{inputenc}  %Kodna stran za Windows okolje, za linux je kodna stran latin2
\usepackage{tikz}
\usepackage{arydshln,leftidx,mathtools}
\usepackage{gensymb}
\usepackage{subfigure}
\usepackage{hhline}
\usepackage[all]{xy}
\usepackage[Slovene]{babel}    % pravila za slovensko deljenje besed
\usepackage[pdftex]{UNI-LJ-FE-Diploma} %Stil za diplome na Fakulteti za elektrotehniko (za pdfTeX v MkiTex)
%\usepackage{cite}
%\usepackage[sort&compress]{natbib}
\input{./BlockDiagrams/tikzsettings.tex}
\input{./macros.tex}
%\usepackage[pctex]{UNI-LJ-FE-Diploma} %Stil za diplome na Fakulteti za elektrotehniko  (za pcTex)

%*************************** PRILAGODITVE *****************************
% mapa s slikami
\potgrafike{./Slike/}
%prilagoditev levega roba sodih strani. Èe se pri dvostranskem tisku robovi ne umemajo se lahko poveèa ali pomanjša
\zamaknirobsodihstrani{0mm}

%*************************** NASLOVNA STRAN *****************************
\naslov{Vodenje industrijskega robota Mitsubishi PA-10 preko UDP-ARCNET strežnika}
\avtor{Timotej Gašpar} 
\univerza{Univerza v Ljubljani}
\fakulteta{Fakulteta za elektrotehniko}
\delo{Magistrsko delo}
\date{Ljubljana, 2015}
\mentor{prof. dr. Matjaž Mihelj}
\somentor{dr. Leon Žlajpah}
\begin{document}

%------------------------ ZAÈETNI DEL -----------------------------------
\frontmatter
%------------------------------------------------------------------------


%************************ NASLOVNA STRAN ********************************
\maketitle


%*************************** ZAHVALA ************************************
\zahvala 

Zahvala gre somentorju Leonu Žlajpahu za pomoè z iskušnjami, znanjem ter dobrimi nasveti.
Zahvalil se bi rad staršem za popolno podporo pri študiju, bratu, ker me je motiviral èeprav tega ni vedel ter partnerki, ker je vedela katere besede izreèi v katerem trenutku.


%*************************** VSEBINA *************************************
\tableofcontents

%*************************** SEZNAM SLIK in TABEL  ***********************
\seznamslik
\seznamtabel

%***************************  SEZNAM UPORABLJENIH SIMBOLOV  **************

\seznamsimbolov

V prièujoèem zakljuènem delu so uporabljeni naslednje velièine in
simboli:

\begin{table}[h]
\centering
%\begin{footnotesize}
\begin{tabular}{l l l l}
 \hline \multicolumn{2}{c}{\bf{Velièina / oznaka}} & \multicolumn{2}{c}{\bf{Enota}}  \\
 \hline
Ime & Simbol & Ime & Simbol \\
 \hline
èas & $t$  & sekunda & s \\
frekvenca & $f$  & Hertz & Hz \\
% tlak & $p$  & Pascal & Pa \\
sila & $F$  & Newton & N \\
% gostota & $\rho$  & - & kg/m$^3$ \\
masa telesa  & $m$  & kilogram & kg \\
% vhodna napestost & $U_\text{vh}$ & volt  & V \\
kot v sklepu  & $q$  & radian na sekundo & rad/s \\
navor v sklepu  & $\tau$  & Newton meter & Nm \\
lega vrha robota & $\textbf{x}$  & metri & m \\
Jacobijeva matrika & $\mathbf{J}$  & - & - \\
matrika homogenih transformacij & $\mathbf{T}$  & - & - \\
rotacijska matrika & $\mathbf{R}$  & - & - \\
matrika vztrajnosti & $\mathbf{B}$  & - & - \\
matrika Coriolisovih in centripetalnih silah & $\mathbf{C}$  & - & - \\
vektor gravitacijskih prispevkov & $\mathbf{g}$  & - & - \\
vektor prispevkov trenja & $\mathbf{F}_f$  & Newton meter & Nm \\
jacobijeva matrika & $\mathbf{J}$  & - & - \\
vektor sil in navorov & $\mathbf{h}$  & - & - \\
proporcionalno ojaèanje & $K_P$  & - & - \\
diferencirno ojaèanje & $K_D$  & - & - \\
integrirno ojaèanje & $K_I$  & - & - \\
regulirni signal & $u$  & - & - \\



\hline
\end{tabular}
%\end{footnotesize}
  \caption{Velièine in simboli}
  \label{prebojne_trdnosti}
\end{table}

Pri èemer so vektorji in matrike napisani s poudarjeno pisavo.
Natanènejši pomen simbolov in njihovih indeksov je razviden iz
ustreznih slik ali pa je pojasnjen v spremljajoèem besedilu, kjer je
simbol uporabljen.


%------------------------ GLAVNI DEL ------------------------------------
\mainmatter
%-------------------------------------------------------------------------


%********************* POVZETEK V SLOVENŠÈINI ****************************
\povzetek

V delu je predstavljen namensko razvit strežnik, ki omogoèa krmiljenje robota Mitsubishi PA-10 preko Ethernet omrežja s pošiljanjem UDP paketov. Strežnik deluje kot posrednik med UDP klientom ter ARCNET krmilnikom servo motorjev robota PA-10. Strežnik deluje v realnem èasu in s frekvenco cikla 500 Hz. Strežnik omogoèa krmiljenje robota preko hitrostnega ali navornega internega regulatorja, kar daje uporabnikom možnost, da lahko implementirajo razliène strategije vodenja.

V delu je predstavljena uporaba razliènih strategij vodenja robotov. V hitrostnem ter navornem naèinu smo opravili poskuse vodenja v zunanjih ter notranjih koordinatah. Dodatno se je še ugotovilo možnosti vodenja robota v kontaktu z okolico. Poskusi so pokazali, da hitrostno vodenje preko strežnika deluje dobro, saj ni tako odvisno od dinamiènih parametrov robota. Navorno vodenje pa je zasnovano na osnovi dinamiènega modela. Ker smo pri realizaciji razliènih naèinov vodenja po navorih uporabili verjetno nenatanène parametre dinamiènega modela, rezultati v primeru uporabe navornega vodenja niso najboljši.

Vodenje na višjem nivoju smo realizirali v okolju \matsim. Razvili smo \simulink blok za povezovanje z razvitim stržnikom, kar daje bodoèim uporabnikom možnost enostavnega implementiranja algoritmov vodenja.

\kljucnebesede PA-10, inverzna kinematika, inverzna dinamika, vodenje robotov, redundantni mehanizem, impedanèno vodenje, admitanèno vodenje, ARCNET-UDP strežnik


%*************************** POVZETEK V ANGLEŠÈINI ***********************
\abstract

For this thesis the authors have developed a server that enables the control of Mitsubishi PA-10 robot via Ethernet network using UDP package protokol. The server acts like a man in the middle for a UDP client and ARCNET 
servo controller of the PA-10 robot. The server works in real time with sample frequency of 500 Hz. The server allows robot control with input velocities or torques which gives the user the reedom of implementing different robot control strategies.

Different control strateges for robot control were presented. We made experiments in velocities and toqrque modes for joint and task space controllers. We also experimented on robot control in contact with enviroment. The experiments showed better resoults in velocity mode as the control is not dependent on dynamic parameters. The toqrue control was implemented with the use dynamic model. The absensce of precise dynamic model parameters lead to unprecise responses in torque mode control.

Higher level control was developed with \matsim program. We developed a \simulink block for communication with the developed server to allow future user easier use.

\keywords PA-10, inverse kinematics, inverse dynamics, robot control, redundant mechanisms, impendance control, admitance control, ARCNET-UDP server 


%***************************** UVOD **************************************
\chapter{Uvod} \label{chap:uvod}

Robot je po ISO 8373:2012 standardu definiran kot mehanizem programirljiv v dveh ali veè oseh z neko stopnjo avtonomije, ki se premika znotraj njegovega okolja za izpolnjevanje zadanih nalog \cite{iso_robotics}, robotika pa kot znanost in veda, ki preuèuje naèrtovanje, izgradnjo in aplikacijo robotov. Prodaja industrijskih robotov se je v zadnjih 15 letih poveèala za kar 250\% in statistika pravi, da so leta 2014 zabeležili rekordno prodajo robotov z 200.000 prodanimi enotami. Ker sta znanost in industrija tesno povezani lahko trdimo, da je tudi raziskovanje na podroèju robotike v porastu.

Vendar pa se je pri vsakem novem robotu potrebno vrniti na osnovno nalogo: vodenje vrha robota. Dandanes imajo robotski manipulatorji v sklepih elektromotorje, ki jih lahko vodimo na dva naèina, hitrostno ter navorno. Prvi naèin predvideva poznavanje le kinematiènega modela, drugi pa veleva poznavanje tudi dinamiènega modela robota. Oba naèina vodenja sta bila v preteklosti obsežno raziskana in opisana. V tem delu bomo predstavili vodenje robota po prostoru naloge preko hitrosti in navorov. Pregledali bomo tudi, kako voditi robota v stiku z okolico s senzorjem sil na vrhu robota.

Robotski manipulator PA-10 ima sedem sklepov zato ga uvršèamo med redundantne robote. Prenosnost, enostavno rokovanje ter odprtost krmilnika so razlogi, da je robot zelo razširjen v raziskovalnih institucijah. Ker pa je podjetje prenehalo s prodajo ter podporo tega robota, so raziskovalci prepušèeni samostojnemu razvijanju programske opreme za vodenje robota. 

Za krmiljenje robota PA-10 smo razvili novo programsko za komunikacijo s krmilnikom servo motorjev robota. Pred izdelavo novega krmilnika smo definirali zahteve po delovanju v realnem èasu ter s hitrostjo 500 Hz. Razvili smo tudi višjenivojski krmilnik za implementacijo opisanih strategij vodenja robota. S poizkusi smo ovrednotili delovanje razvitega krmilnika ter analizirali razliène strategije vodenja po prostoru naloge brez in v kontaktu z okolico.


%*********************** OSREDNJA POGLAVJA ********************************

%*********************** PA10 ********************************
\chapter{Robotski manipulator PA-10} \label{chap:pa10}

Podjetje Mitsubishi Heavy Industries je leta 1992 izdelalo prvega katalogiranega industrijskega redundatnega robota \cite{mhi_pa10}. Podjetje je robota poimenovalo Portable General-purpose Intelligent Arm PA-10, krajše PA-10. Gre za serijskega robota s sedmimi stopnjami prostosti (slika \ref{fig:pa10drawing}). Prvi trije sklepi so oznaèeni kot ramenski sklepi (ang. \textit{shoulder}), S1, S2, S3. Naslednja dva sta oznaèena kot komolèni sklepi (ang. \textit{elbow}), E1, E2. Zadnja dva sklepa pa sta oznaèena kot zapestna (ang. \textit{wrist}), W1, W2. Glede na zgradbo se ga uvrsti v tako imenovane antropomorfne robote \cite{craig_robintro}.
%Izraz antropomorfnost izhaja iz dveh grških besed \textit{antropo} - èlovek, \textit{morphe} - oblika. 
Znaèilnost takih robotov je visoka stopnja spretnosti saj so vsi sklepi rotacijski \cite{siciliano_robot}.

Masa robotske roke PA-10 je 36 kg in ima nosilnost 10 kg. Servo motorji v sklepih se napajajo preko izmeniène napetosti. Prenosi med v sklepih so realizirani s harmoniènimi gonili. Baza robota se lahko pritrdi v katerokoli lego. To pomeni, da se ga lahko fiksira bodisi na tla, na steno ali na strop. Robota PA-10 odlikuje relativno lahka konstrukcija, enostavno rokovanje ter odprtost njegovega krmilnika. Prav ti razlogi so povod, da je mnogo instituciji vzelo tega robota kot eksperimentalni sistem za razvijanje raznih algoritmov vodenja \cite{voung_pa10,aalst_pa10,rodrigo_pa10,petric_nevronska}.

\input{./Slike/pa10-drawing.tex}

\section{Kinematièni model robota PA-10} \label{sec:pa10_kin_model}

Robotski mehanizem obravnavamo kot kinematièno verigo \textit{n} med seboj povezanih togih teles, reèemo jim tudi kinematièni pari. Ker je en konec kinematiène verige, t.j. baza robota, togo pritrjen v bazo se premika le vrh kinematiène verige. Z opisom kinematiène relacije med dvema zaporednima segmentoma je mogoèe definirati kinematièno relacijo med bazo in vrhom robota. Homogena transformacijska matrika je operator, ki opisuje translacijo in rotacijo med dvema koordinatnima sistemoma. Definiramo jo kot \cite{siciliano_robot}

\begin{equation}
	\textbf{T}_{i+1}^i = 
	\begin{bmatrix}
		\cos(\varTheta_i) && -\sin(\varTheta_i) && 0 && a_i \\
		\sin(\varTheta_i) \cos(\alpha_i) && \cos(\varTheta_i) \cos(\alpha_i) && -\sin(a_i) && -\sin(a_i)d_i \\
		\sin(\varTheta_i) \sin(\alpha_i) && \cos(\varTheta_i) \sin(\alpha_i) && \cos(a_i) &&  \cos(a_i)d_i \\
		0 && 0 && 0 && 1
	\end{bmatrix},
\end{equation}

kjer so $\textit{a}_i$, $\alpha_i$, $d_i$ in $\varTheta$ Denavit - Hartemberg (D-H) parametri in opisujejo relacijo med dvema koordinatnima sistemoma.

Sklicujoè na sliko \ref{fig:d-h_drawing} se D-H parametre parametre opiše kot:

\input{./Slike/d-h_drawing.tex}

\begin{itemize}
	\item $\textit{a}_i$ razdalja med $O_i$ in $O_{i+1}$ v smeri $x_i$,
	\item $\alpha_i$ kot med $O_i$ in $O_{i+1}$ glede na os $x_i$,
	\item $d_i$ razdalja med $O_{i-1}$ in $O_{i}$ glede na os $z_i$,
	\item $\varTheta$ razdalja med $O_{i-1}$ in $O_{i}$ glede na os $z_i$,
\end{itemize}


Z množenjem homogenih transformacijskih matrik posameznih sklepov med seboj dobimo homogeno transformacijo med vrhom robota in njegovo bazo:


\begin{equation} \label{eq:tob}
\textbf{T}_{7}^0 = \textbf{T}_1^0  \textbf{T}_2^1  ...  \textbf{T}_7^6.
\end{equation}

D-H parametre za robota PA-10 definiramo na osnovi podatkov proizvajalca \cite{pa10-manual} in so podani na sliki \ref{fig:pa10-dh}. V tabeli \ref{table:dh_params} so zapisani D-H parametri za vse kinematiène pare. Koti v sklepih robota so zapisani kot $q_n$ in jih imenujemo notranje koordinate. Glede na D-H sistem v našem primeru $q_i$ ustreza parametru $\theta_i$. Z upoštevanjem tega postane matrika \thom funkcija kotov v sklepih $\mathbf{q} = \begin{bmatrix} q_1 & q_2 & \dots & q_7 \end{bmatrix}^T$. 

\input{./Slike/pa10-dh.tex}
%\input{./Slike/two-coordinates.tex}
%\input{./Slike/arm_length.tex}

\begin{table}
\centering	

	\begin{tabular}{l | l l l l l l}

		 
		\textit{i}	& $ \alpha_{i-1} $ & $a_{i-1}$ & $d_i$ & $ \theta_i $ \\
		\hline
		1			& 0 & 0 & 0.315 & \textit{q1} \\
		2			& $-\frac{\pi}{2}$ & 0 & 0 & \textit{q2} \\
		3			& $\frac{\pi}{2}$ & 0 & 0.45 & \textit{q3} \\
		4			& $-\frac{\pi}{2}$ & 0 & 0 & \textit{q4} \\
		5			& $\frac{\pi}{2}$ & 0 & 0.5 & \textit{q5} \\
		6			& $-\frac{\pi}{2}$ & 0 & 0 & \textit{q6} \\
		7			& $\frac{\pi}{2}$ & 0 & 0.08 & \textit{q7} \\
	
	
	\end{tabular}
  \caption{D-H parametri}
  \label{table:dh_params} 
\end{table}

Opis lege vrha robota se da skrajšati in zapisati z minimalnim številom koordinat. V matriki homogene transformacije lahko poišèemo vektor translacije \textbf{p} in rotacijsko matriko \textbf{R} (slika \ref{eq:t_pieces}).

\begin{equation} \label{eq:t_pieces}
\textbf{T} = 
\left[
\begin{array}{c;{2pt/2pt}c}
\textbf{R}^{3 \times 3} & \textbf{p}^{1 \times 3} \\ \hdashline[2pt/2pt]
\textbf{0}^{3 \times 1}  & 1 
\end{array}
\right]
\end{equation}

Pozicija se enostavno izpiše iz prvih treh vrstic zadnjega stolpca, vektor \textbf{p}. Za zapis orientacije pa se je potrebno sklicati na Eulerjeve kote, ki jih lahko izraèunamo iz èlenom podmatrike \textbf{R}. Èe omenjeno podmatriko zapišemo kot

\begin{equation}
\textbf{R} = 
\begin{bmatrix}
r_{11} & r_{12} & r_{13} \\
r_{21} & r_{22} & r_{23} \\
r_{31} & r_{32} & r_{33} \\
\end{bmatrix},
\end{equation}
lahko definiramo tri Eulerjeve kote na sledeè naèin
  
\begin{equation}
	\varphi = \arctan2(r_{21},r_{11}), 
	\vartheta = \arctan2(-r_{31},\sqrt{r_{32}^2 + r_{33}^2}), 
	\psi = \arctan2(-r_{32},-r_{33}).
\end{equation}
Z združitvijo treh koordinat za opis pozicije in treh koordinat za opis orientacije se lahko definira vektor, ki opisuje neko toèko v prostoru baze robota:

\begin{equation}
	\textbf{x} =
	\left[ \begin{array}{@{}*{11}{c}@{}}
		x & y & z & \varphi & \vartheta & \psi \\
	\end{array} \right]^T.
\end{equation}
Vektor $x$ se imenuje tudi vektor zunanjih koordinat. Sedaj je mogoèe opisati enaèbo direktne kinematike kot funkcijo $\textbf{q}$:

\begin{equation} \label{eq:dir-kinematics}
	\textbf{x} = \textbf{k}(\textbf{q}).
\end{equation}

Funkcija $\textbf{k}(\textbf{q})$ je vektorska funkcija notranjih koordinat, v katerih so zajete kinematiène enaèbe pozicije in orientacije mehanizma. Problem direktne kinematike je pri serijskih mehanizmih enostavno rešljiv in ima eno rešitev \cite{lenarcic_robotmeh}.

Potrebno je še opisati, kakšna je hitrost vrha robota v odvisnosti od hitrosti v sklepov. Z odvajanjem enaèbe (\ref{eq:dir-kinematics}) po $\textbf{q}$ dobimo
\begin{equation} \label{eq:dir-kin-vel}
	\dot{\mathbf{x}}	= \frac{\partial \mathbf{k}(\mathbf{q})}{\partial \mathbf{q}} \mathbf{q} = \textbf{J} \dot{\mathbf{q}},
\end{equation}
kjer je \textbf{J} Jacobijeva matrika in predstavlja parcialne odvode zunanjih koordinat.

%BEGIN_FOLD
%\begin{equation}
%	\textbf{J} = 
%	\begin{bmatrix}
%		\frac{\partial p_1}{\partial q_1} && \frac{\partial p_1}{\partial q_2} && \dots && \frac{\partial p_1}{\partial q_7} \\
%		\frac{\partial p_2}{\partial q_1} && \frac{\partial p_2}{\partial q_2} && \dots && \frac{\partial p_2}{\partial q_7} \\
%		\vdots && \vdots && \ddots && \vdots \\
%				\frac{\partial p_6}{\partial q_1} && \frac{\partial p_6}{\partial q_2} && \dots && \frac{\partial p_6}{\partial q_7} \\
%	\end{bmatrix}.
%\end{equation}
%END_FOLD

Z odvajanjem enaèbe (\ref{eq:dir-kin-vel}) je mogoèe zapisati še relacijo med pospeški vrha robota ter pospeški sklepov 

\begin{equation} \label{eq:dir_dyn_accel}
\ddot{\mathbf{x}} = \mathbf{J} \ddot{\mathbf{q}} + \dot{\mathbf{J}} \dot{\mathbf{q}},
\end{equation}
kjer je $\dot{\mathbf{J}}$ odvod Jacobijeve matrike.
%\begin{equation} \label{eq:dir_dyn}
%	\dot{\textbf{x}} = \textbf{J} \dot{\textbf{q}}.
%\end{equation}







\section{Dinamièen model robota} \label{sec:pa10-dynmodel}

Vodenje robota z referenènimi navori veleva poznavanje njegovega dinamiènega modela. S poznavanjem dinamiènega modela je mogoèe opisati silo s katero bo vrh robota deloval v kontaktu z okolico. Z razliko od kinematiènega modela je pri dinamiènem modelu število parametrov, ki vplivajo na vodenje veèje. V nadaljevanju bo predstavljen splošen dinamièen model in relacija med silami, ki delujejo na vrhu robota in navori v sklepih.

Enaèbe gibanja kot posledica delovanja sil in navorov se lahko zapišejo z uporabo Lagrangevih formulacij


\begin{equation}\label{eq:lagrange_form}
	\begin{array}{r c l}
		\Lagrl(q,\dot{q}) &=& \Lagrt(q,\dot{q}) - \Lagru(q), \\
		\boldsymbol{\tau} &=&  \displaystyle \frac{d}{dt}(\frac{\partial \Lagrl}{\partial \dot{q}_i}) - \frac{\partial \Lagrl}{q_i}
	\end{array}
\end{equation}
kjer $\Lagrt$ in $\Lagru$ opisujeta kinetièno in potencialno energijo, $ \boldsymbol{\tau} $ pa generalizirane sile.

Lagrangeve formulacije so orodje za sistematièen opis dinamike posameznih segmentov \cite{siciliano_robot}. Z uporabo formulacije (\ref{eq:lagrange_form}) se lahko zapiše enaèbo navorov v sklepih v odvisnosti od kotov, hitrosti in pospeškov v sklepih na sledeè naèin:

\begin{equation} \label{eq:din}
\pmb{\tau}(\mathbf{\ddot{q}},\mathbf{\dot{q}},\textbf{q}) = \textbf{B}(\textbf{q})  \ddot{\textbf{q}} + \textbf{C}(\textbf{q},\dot{\textbf{q}})  \dot{\textbf{q}} + \textbf{F}_f(\dot{\textbf{q}}, \textbf{q}) + \textbf{g}(\textbf{q}) + \textbf{J}^T(\textbf{q})\textbf{h}_o.
\end{equation}
Posamezni èleni zgornje enaèbe bodo opisani v nadaljevanju.

Matrika $\textbf{B}(\textbf{q})$ predstavlja zapis vztrajnosti posameznih segmentov. Odvisna je od trenutne konfiguracije robota. Posamezni èleni pa so izraèunani kot

\begin{equation}
	b_{i,j} = \sum_{i = max(j,k)}^{n} Tr[(\frac{\partial}{\partial q_k}\textbf{T}^0_i)(\frac{\partial}{\partial q_j}\textbf{T}^0_i)].
\end{equation}
Operator \textit{Tr} je sled matrike, to je vsota diagonalnih èlenov matrike.

Matrika $\mathbf{C}(\mathbf{\mathbf{q},\dot{q}})$ vkljuèuje podatke o Coriolisovih in centripetalnih silah. Njeni èleni izraženi s pomoèjo kot 


\begin{equation}
c_{i,j} = \sum_{k=1}^{n} c_{i,j,k} \dot{q}_k	,
\end{equation}
kjer so 
\begin{equation}
%	c_{i,j,k} = \sum_{i = max(i,j,k)}^{7} sl[(\frac{\partial^2}{\partial q_k \partial q_l }T^0_i)J_i(\frac{\partial}{\partial q_j}T^0_i)^T],
c_{i,j,k} = \frac{1}{2}(\frac{\partial b_{ij}}{\partial q_k} + \frac{\partial b_{ik}}{\partial q_j} - \frac{\partial b_{jk}}{\partial q_i}),
\end{equation}
Christoffelovi simboli in dodatno velja še $i,j,k = 1, \dots ,n$.

Vektor $\mathbf{g}(\mathbf{q})$ predstavlja navor proizveden v sklepih manipulatorja zaradi vpliva gravitacije \cite{siciliano_robot}. Posamezen èlen vektorja  $\mathbf{g}(\mathbf{q})$ je podan kot

\begin{equation}
 g_i = \sum_{i=j}^{n} (-m_i \mathbf{g}_0(\frac{\partial}{\partial q_j}\mathbf{T_i^0})^T\textbf{r}_i),
\end{equation}

kjer je $\textbf{g}_0 $ vektor gravitacijskega pospeška $\textbf{g}_0 = \begin{bmatrix} 0 & 0 & -9,81\end{bmatrix}^T$. Vektor $\textbf{r}_i$ opisuje mesto težišèa v segmentu, $m_i$ pa opisuje maso segmenta.

Vektor $\mathbf{F}_f$ opisuje vplive trenja. Vektor zajema tako Coulombovo trenje kot tudi viskozno trenje. Posamezni èleni vektorja, $f_i$ so prispevki trenja v $i$-tem sklepu. Podrobneje bo ta prispevek obravnavan v poglavju \ref{chap:invdyn}.

Vektor $\textbf{h}_o$ vsebuje sile in navore, ki delujejo na vrh robota, $\textbf{h}_o = \begin{bmatrix} f_x & f_y & f_x & m_x & m_y & m_z \end{bmatrix}$, kjer prvi trije èleni vektorja opisujejo sile, drugi trije pa navore.

\section{Inverzna kinematika} \label{sec:redundant-pa10}

Nalogo, ki jo opravlja robot tipièno opišemo s èasovnim potekom vektorja $\textbf{x}$, kot je podan v enaèbi (\ref{eq:dir-kinematics}). Da bi lahko izvedli želeno gibanje, je potrebno poiskati ustrezne vrednosti notranjih koordinat $\textbf{q}$, kar predstavimo z enaèbo

\begin{equation}\label{eq:inverse-kinematics}
	\textbf{q} = \textbf{k}^{-1}(\textbf{x}),
\end{equation}
kjer je $\textbf{k}^{-1}$ inverz funkcije $ \textbf{k}$ Ta funkcija predstavlja inverzno kinematiko. Èeprav je bila rešitev enaèbe (\ref{eq:dir-kinematics}) enolièna, pa enaèba (\ref{eq:inverse-kinematics}) nima vedno enoliène rešitve. Še veè, rešitev obstaja le, èe $\textbf{x}$ leži v delovnem prostoru robota.

Pri vodenju robotov veèinoma ne rešujemo inverzne dinamike direktno iz enaèbe (\ref{eq:inverse-kinematics}) ampak preko hitrosti, torej iz enaèbe (\ref{eq:dir-kin-vel}). Èe predpostavimo, da je dimenzionalnost prostora naloge \textit{m} in èe velja, da je $m = n$, potem lahko doloèimo hitrost v sklepih iz relacije
\begin{equation}
\dot{\textbf{q}} = \textbf{J}^{-1} \dot{\textbf{x}},
\end{equation}
kje je $\textbf{J}^{-1}$ inverz Jacobijeve matrike.

V primeru, da pa ima robot veè stopenj prostosti, kot jih je potrebno za izvedbo naloge, torej èe je $n > m$, potem inverz $\textbf{J}^{-1}$ ne obstaja in je potrebno poiskati rešitev inverzne kinematike drugaèe. Enaèbo (\ref{eq:dir-kin-vel}) lahko invertiramo z uporabo naslednje zveze
\begin{equation} \label{eq:inv_dyn_null}
\dot{\mathbf{q}} = \mathbf{J}^* \dot{\mathbf{p}} + \mathbf{N} \dot{\mathbf{q}},
\end{equation}
kjer je $\textbf{J}^*$ generaliziran inverz matrike $\textbf{J}$, matrika $\textbf{N}$ pa predstavlja projekcijo v nièelni prostor matrike $\textbf{J}$, 
\begin{equation}
\mathbf{N} = (\mathbf{I} - \mathbf{J}^{*}\mathbf{J}).
\end{equation}

Prvi èlen enaèbe (\ref{eq:inv_dyn_null}) predstavlja partikularno rešitev in zadosti osnovni nalogi, zagotovi, da je vrh robota v $\textbf{x}$. Drugi èlen enaèbe (\ref{eq:inv_dyn_null}) pa predstavlja homogeno rešitev in omogoèa rekonfiguracijo robotskega mehanizma brez, da se spremeni pozicija vrha robota $\textbf{x}$. Zaradi tega se hitrost $\dot{q}_n$ lahko uporabi za realizacijo dodatnih nalog nižje prioritete.


%BEGIN_FOLD
%
%Kot je bilo opisano ima robotski mehanizem PA-10 sedem sklepov oz. sedem stopenj prostosti ($n = 7$). Takim mehanizmom pravimo da so kinematièno redundantni v kolikor je njihova naloga definirana z $m$ stopnjami prostosti in velja neenakost $n > m$. Industrijski roboti imajo obièajno šest stopenj prostosti, ker je v veèini primerih opisana naloga v prostoru naloge šest dimenzionalna. Èe bi veljalo \textit{n} = \textit{m} bi matrika \textbf{J} bila kvadratna. Posledièno bi je njen inverz možno enostavno definirati in velja relacija
%
%Ker pa velja $ n > m$ pa matrika \textbf{J} ni veè kvadratna in njen inverz ne obstaja. V tem primeru je mehanizem redundanten za dano nalogo in je število rešitev inverzne kinematike neskonèno.
%
%V tem primeru obstajajo neke spremembe notranjih koordinat, ki ne vplivajo na premikanje vrha robota. Opis inverzne kinematike z uporabo generaliziranega pseudo inverzna Jacobijeve matrike $\textbf{J}^*$ se lahko zapiše kot 
%
%
%Matrika $\mathbf{N}$ projicira- vektorje $\dot{\mathbf{q}}$ v nièelni prostor matrike \textbf{J} in je definirana kot $\mathbf{N} = (\mathbf{I} - \mathbf{J}^{\#}\mathbf{J})$. 
%END_FOLD

Kot generaliziran inverz matrike $\mathbf{J}^*$ se pogosto uporablja Moore-Penroseov pseudoinvez
\begin{equation} \label{eq:j_t}
\mathbf{J}^+ =  \mathbf{J}^T (\mathbf{J} \mathbf{J}^T)^{-1}.
\end{equation}
ali uteženi Moore-Penroseov pseudoinverz
\begin{equation} \label{eq:pseudoinv_def}
\mathbf{J}^* = \mathbf{J}^{\#} = \mathbf{W}^{-1} \mathbf{J}^T (\mathbf{J} \mathbf{W}^{-1} \mathbf{J}^T)^{-1},
\end{equation}
kjer je $\textbf{W}$ utežnostna matrika.

Z odvajanjem enaèbe (\ref{eq:inv_dyn_null}) dobimo relacijo med pospeški v sklepih in pospeških na vrhu robota. 

\begin{equation} \label{eq:pseudoinv_def_accel}
	\ddot{\textbf{q}} = \textbf{J}^{*} (\ddot{\mathbf{p}} + \dot{\mathbf{J}}\dot{\mathbf{q}})+\textbf{N} \ddot{\mathbf{q}}_N,
\end{equation}

kjer je $ \ddot{\mathbf{p}} $ pospešek vrha robota, pospešek $ \ddot{\mathbf{q}}_N $ pa poljubni pospešek v notranjih koordinatah, ki se uporabi za realizacijo dodatnih nalog in ne vpliva na pospešek gibanja vrha robota.


%*************************************************************** ARCNET - UDP STREŽNIK ***************************************************************
\chapter{ARCNET - UDP strežnik za komunikacijo s krmilnikom robota ter senzorjem sile} \label{chap:udp-arcnet-server}

V prejšnjem poglavju je bil opisan kinematièni in dinamièen model robota PA-10. V tem poglavju pa bo predstavljen krmilnik motorjev v sklepih in program, ki je nastal za komunikacijo s krmilnikom.

V sklepih robota PA-10 so servo motorji, katerih se izvaja vodenje preko moènostnega krmilnika.
Krmilnik omogoèa vodenje servo motorjev preko referenène hitrosti ali referenènega navora. Komunikacija s tem krmilnikom poteka preko komunikacijskega vmesnika ARCNET, ki omogoèa nastavitve moènostnih ojaèevalnikov v krmilniku, izbiro naèina krmiljenja in seveda pošiljanja želenih hitrosti ali navorov v sklepih. Preko te povezave se pošiljajo nazaj tudi informacije o stanju robota in krmilnika (pozicija, navori, statusi, ...).

Za samo vodenja robota pa se uporablja dodaten vmesnik, t. i. MHI Controller, ki omogoèa vodenje robota na razliène naèine. Na žalost pa ima ta vmesnik kar precej omejitev, ki onemogoèajo napredno vodenje robota. Omejujoèe so predvsem naslednje stvari: izvaja se lahko le vodenje po hitrosti, ki navzgor dokaj strogo omejena in najveèja frekvenca vzorèenja je 100 Hz.

Te omejitve v MHI vmesniku omejujejo kvalitetno vodenje z upoštevanjem sil in kompenzacijo dinamiènih vplivov. Ker pa je zasnova krmilnika dokaj odprta in omogoèa komunikacijo preko ARCNET omrežja dokaj dobro, smo razvili lasten krmilni sistem na višjem nivoju, ki bo omogoèal implementacijo sodobnih naèinov vodenja, tako s hitrostnim kot z navornim naèinom vodenja.

Pred zaèetkom izdelave lastnega strežnika se je definiralo dve zahtevi, ki jih mora program izpolnjevat. Prva je bila, da program deluje dovolj hitro, da se lahko izvaja v realnem èasu. To je pomembno za zagotovitev kvalitetnega in stabilnega vodenja. Avtor v \cite{mihelj_hapt} namreè navaja, da vzorèni èas moèno vpliva na stabilnost vodenja robota v kontaktu z okolico. Veèja kot je vzorèna frekvenca veèja je lahko togost okolice s katero je robot v kontaktu. Druga zahteva pa je bila enostavna uporaba. Krmilnik bi moral uporabniku omogoèati razvijanje visokonivojskih algoritmov vodenja brez poznavanja detajlov delovanja ARCNET omrežja in krmilnika robota. Uporabnik mora imeti možnost proste izbire programskega okolja za realizacijo vodenja. Dodatno se je kasneje pojavila še želja, da bi krmilni sistem vkljuèeval tudi vmesnik za senzor sil in navorov JR3.

\input{./Slike/pc_zadaj_labels.tex}
Razvili smo strežnik, ki je zadostoval vsem navedenim kriterijem in hkrati tudi dopušèa možnost nadgrajevanj. Nastali strežnik deluje kot ARCNET-Ethernet posrednik in deluje na osebnem raèunalniku \ref{fig:pc_zadaj_labels}, ki ima operacijski sistem Linux.


%****************************************************** SERVO KRMILNIK ***************************************************************
\section{Krmilnik servo motorjev robota} \label{sec:servo-drive}

V prvem poglavju je bilo zapisano, da robota PA-10 med drugim odlikuje dobra prenosnost. To velja tako za samo robotsko roko kot tudi za krmilnik servo motorjev. Krmilnik z ohišjem ima dimenzije $262 \times 331 \times 396$ mm in maso 22 Kg. Slika (slika \ref{fig:pa10-servo}) prikazuje tehnièno risbo krmilnika.

\input{./Slike/pa10-servocontroller.tex}

V ohišju servo krmilnika so vgrajeni štirje krmilniki servo motorjev. Trije vodijo po dva motorja, eden pa le enega. Krmilniki omogoèajo vodenje motorjev na dva naèina, navorno in hitrostno. Razlièna vodenja sta v krmilnikih drugaèe realizirana. Navorno vodenje je realizirano z analognim P regulatorjem toka. To izvira iz modela elektriènega motorja, ki pravi, da je navor na gredi proporcionalen toku s katerim motor napajamo \cite{miljavec_stroji}. Hitrostna regulacija pa je realizirana z digitalnim PI regulatorjem s frekvenco približno 1500 Hz. Kot povedano, so prenosi realizirani s harmoniènimi gonili. Prestavno razmerje je 1:50. Na strani reduktorja je 14 - bitni enkoder, kar pomeni, da je resolucija merjenja kota približno $0.4 \cdot 10^{-3}$ stopinj. Krmilnik ima tudi vgrajen varnostni sistem, ki prepreèuje, da bi se sklepi preveè zasukali in ob morebitnem pretiranem zasuku vklopi zavoro in tako prepreèi, da bi šel do svojih mehanskih omejitev. 

Krmilnik vsebuje dva pomnilnika. Delovni pomnilnik (RAM) in nastavitveni pomnilnik (EEPROM). V EEPROM tabeli so zapisani parametri za nastavitve in vodenje servo krmilnikov. Ob zagonu krmilnika se parametri naložijo iz EEPROM tabele v RAM. Med naloženimi parametri so tudi ojaèanje proporcionalnega ter integracijskega dela regulatorja, omejitve posameznih stopenj, razmerje prenosa zobnikov, itd.

\section{ARCNET vmesnik}\label{sec:arc_drive}

Referenène navore in hitrosti se na krmilniku nastavlja preko zunanjega vmesnika, ki je povezan na enako ARCNET omrežje kot servo krmilnik. Prikljuèitev servo krmilnika na omrežje omogoèa vgrajen ARCNET modul. ARCNET je omrežje, ki vkljuèuje podatkovni in fizièni nivo po OSI modelu, komunikacija pa je serijska in paketno zastavljena. Njegova prednost pred Ethernet omrežjem je velika stopnja deterministiènosti \cite{arc_tutorial}. Krmilnik robota ima dva prikljuèka za optièna vodila, vhod (Rx) ter izhod (Tx). Zgornja meja hitrosti komunikacije z krmilnikom robota je 5 Mb/s \cite{pa10-manual}.

Pakete, ki jih pošiljamo na krmilnik servo motorjev robota, je potrebno sestavit tako, kot je napisano v dokumentaciji \cite{pa10-manual}. Èe želimo, da bo krmilnik paket prejel, je na prvi bajt potrebno vpisati naslov krmilnika. ARCNET modul vsebuje konèni avtomat stanj, ki preklaplja med stanji glede na tip poslanih podatkov. Razlièni tipi podatkov so definirani z razliènimi kodami, znotraj poslanega paketa. Struktura ARCNET paketa je prikazana na sliki \ref{fig:arcnet-packet}.
\input{./Slike/arcnet-packet.tex}

Preklapljanje med stanji in potrebne kode za prehod v ta stanja opisuje slika \ref{fig:pa10-state}. Ikona \includegraphics[scale=0.6]{./Slike/little-arrow.eps} oznaèuje stanja, v katerih se avtomat lahko zadrži dlje èasa s ponavljajoèim pošiljanjem paketov z enakim tipom podatkov. Iz teh stanj izstopi v primeru, da nov paket ne pride pravoèasno, ali pa da pride paket s tipa E. Ko višjenivojski vmesnik ne pošilja nobenih ukazov je ARCNET vmesnik v stanju èakanja, v katerem èaka na primerno sestavljen paket.



\input{./Slike/pa10-state.tex}

Za delo z robotom je pomemben predvsem naèin "Vodenje sklepov", v katerem se dejansko vodi gibanje robota. V tem naèinu je potrebno upoštevati predpisano maksimalno zakasnitev med zaporednima paketoma, ki je definirana v EEPROM tabeli in je tovarniško nastavljena na 300 ms. V kolikor je ta zakasnitev prekoraèena, se avtomat stanj vrne v zaèetno stanje in je vodenje prekinjeno. Ta naèin se izbere tako, da se ARCNET vmesniku najprej pošlje ukaz tipa S, nadaljuje pa se s pošiljanjem paketov tipa C ter zakljuèi s tem, da se pošlje paket tipa E (slika \ref{fig:pa10-control-state}).
\input{./Slike/pa10-control-state.tex}
Del paketa, ki je oznaèen s "podatki" nosi podatke, na podlagi katerih se vodi robota. Vsebina podatkovnega dela je odvisna od tipa paketa.

\input{./Slike/arcnet-data.tex}

Paketa, tipa S in E imata podatkovni del prazen. Paket tipa C pa ima v podatkovnem delu prvih 35 bajtov zapolnjenih s podatki za vodenje robota. Slika \ref{fig:arcnet-data} prikazuje vsebino podatkovnega dela omenjenih paketov. V sliki so krmilni podatki oznaèeni z $ \mathrm{k}_i $, $\mathrm{n}_i $ in $\mathrm{v}_i $. Njihov pomen pa je:

\begin{itemize}
	\item k - kontrolni bajt (velikost podatka: byte),
	
	\begin{itemize}
		\item bit 0: zavora (1 - vklop, 0 - izklop),
		\item bit 1: servo motor (1 - vklop, 0 - izklop),
		\item bit 2: naèin krmiljenja (1 - navor, 0 - hitrost),
		\item biti 3 - 7: se en uporabljajo,
	\end{itemize}
		
	\item n - referenèni navor (velikost podatka: word)  = 0.001 Nm/digit,
	
	
	\item v - referenèna hitrost (velikost podatka: word) = 0.0002 rad/s/digit.
	
\end{itemize}
Poslani referenèni navori in hitrosti gredo od vrednosti 0x0000 do 0xFFFF. Krmlinik ima zaradi varnosti nastavljene omejitve obeh velièin, zato prevelike referenène signale omeji in zagotovi varno gibanje do omejitev.

\section{Senzor sile in navorov - JR3}

Za realizacijo vodenja opisanega v poglavju \ref{sec:vodenje-admitance} smo med vrhom robota ter prijemalom pritrdilo senzor sil JR3 (slika \ref{fig:jr3-slika}). Senzor nam omogoèa merjenje sil in navorov v $x$, $y$ in $z$ oseh. Senzor je narejen iz uporovnih listièev porazdeljenih po notranjosti senzorja, ki je v obliki križa. Iz specifikacij senzorja \cite{jr3_doc_ext} je razvidno, da uporablja 6 uporovnih listièev. S tem, ko na senzor deluje zunanja sila ali navor, pride do deformacije materjala na katerem so namešèeni uporovni listièi in se upornost na uporovnih listièih spremeni proporcionalno s silo in togostjo senzorja. Sprememba upornosti se izmeri posredno preko spremembe napetosti na AD-pretvorniku, ki je vgrajen v sam senzor. Napetost se pretvori v silo preko množenja s kalibracijsko matriko $ \textbf{K}_{calib} $. Naj bo $\textbf{h}_{JR3}$ vektor sil, ki delujejo na senzor in naj bo $\mathbf{u}_u$ vektor napetosti na AD-pretvorniku. Enaèba za izraèun sil je
\input{./Slike/jr3-slika.tex}


\begin{equation}
\textbf{h}_{JR3} = \textbf{K}_{calib} \mathbf{u}_u
\end{equation}

Senzor je priklopljen na raèunalnik preko 8 žilnega kabla s kontektorjem tipa RJ-45 v ISA kartico. Elektronika v samem senzorju serijsko pošilja podatke o izmerjenih silah na kartico. Kartica vsebuje vezje za digitalno obdelavo signalov (ang. \textit{digital signal processor} - DSP). V dokumentaciji kartice \cite{jr3_doc_inst} so opisani trije nizkoprepustni filtri z razliènimi mejnimi frekvencami. Uporabili smo filter z mejno frekvenco 500 Hz.


\input{./Slike/dsp-registers.tex}

DSP kartica na ISA vodilu zavzame dva 16-bitna naslova: osnovnega (\textit{base address}) ter naslednjega. Osnovni se uporabi kot naslovni register, drugi pa kot podatkovni register. Preko vhodno/izhodnih vrat raèunalnika lahko nastavljamo vsebino teh registrov. Na ta naèin lahko dostopamo do internih registrov DSP kartice. Na kartici so stikala preko katerih nastavimo osnovni naslov (\textit{base address}) kartice. Èe je osnovni naslov 0x314 bo naslovni register dostopen na 0x314, podatkovni pa na 0x316. Podatke na registrih DSPja preberemo tako, da na naslovni del zapišemo naslov registra. DSP nato napiše vsebino registra na podatkovni register ISA vodila. Èe želimo v register DSPja nekaj zapisati, pa moramo mi zapisati podatek na podatkovni del ISA registra (slika \ref{fig:dsp-registers}). Za branje ter pisanje po registrih DSP kartice uporabimo sledeèi funkciji v sintaksi programskega jezika C:


\begin{verbatim}
#define baseAdde 0x314

int getData(int addr)
{
	outport(baseAddr, addr);
	return inport(baseAddr + 2);
}

int putData(int addr, int data)
{
	outport(baseAddr, addr);
	outport(baseAddr + 2, data);
}
\end{verbatim}


Dokumentacija navaja, da v kolikor želi uporabnik odèitati vrednost sile ali navora $F$ mora prebrati osnovno vrednost $F_s$ na registru imenovanem (\verb|full scale|), jo pomnožiti z vrednostjo $F_f$, ki je na registru izbranega filtra (\verb|current force|). Nazadnje more to vrednost deliti s konstanto $K_p$, da pretvori podatke v ustrezne enote(N ali Nm).

\begin{equation}\label{eq:force_filt}
F = \frac{F_s  F_f}{K_p}
\end{equation}
Ker senzor meri silo in navor v treh smereh, je potrebno opraviti izraèun za vsako smer.


\section{Strežnik} \label{sec:streznik}

V uvodu v poglavje smo omenili, da je proizvajalec pripravil vmesnik za vodenje robota, MHI Controller, vendar smo se zaradi omejitev tega vmesnika, odloèili za izgradnjo lastnega vmesnika. Definirane zahteve so bile visoka frekvenca, delovanje v realnem èasu ter enostavnost uporabe. Poleg tega pa smo želeli, da nov vmesnik vkljuèuje tudi povezavo s senzorjem sil na vrhu robota.

Ko smo se lotili izgradnje strežnika smo se najprej morali odloèiti, na kakšni platformi bo strežnik deloval. Zaradi enostavnosti razvijanja smo izbrali oseben raèunalnik, na katerega se lahko priklopi ISA kartico za senzor sil JR3 ter ARCNET mrežno kartico za komunikacijo s krmilnikom PA-10. Naslednja odloèitev je bila izbira operacijskega sistema. Odloèali med Windows, Linux ali XPCtarget sistemi. Na koncu smo se odloèili za operacijski sistem Linux, saj ga odlikujejo naslednje lastnosti:
\begin{itemize}
	\item prosto dostopen,
	\item podpora za ARCNET omrežje,
	\item dobra podpora za dostop do izhodno/vhodnih vrat,
	\item dobro èasovne lastnosti \cite{linux_windows}.
\end{itemize}
%\input{./Tabele/pro-cons-os.tex}


Nov vmesnik deluje kot posrednik med dvema razliènima omrežjema (slika \ref{fig:udp-arcnet-server}), ARCNET in UDP. Osnovna funkcionalnost razvitega strežnika je, da posreduje podatke, ki jih uporabnik pošilja preko UDP paketov, krmilniku robota PA-10 v obliki ARCNET paketov in v drugi smeri stanje robota.  V nadaljevanju bo opisana zgradba tega strežnika, njegovo delovanje ter uporaba. 

\input{./Slike/udp-arcnet-server.tex}

\subsection{Delovanje programa}

Razviti program deluje kot strežnik, kar pomeni, da se odzove na klientovo zahtevo. Klient je kakršen koli program, ki lahko pošilja UDP pakete po Ethernet omrežju. Za komunikacijo med klientom in strežnikom smo definirali strukture UDP paketa za pošiljanje in sprejem. Paket je velik 99 bajtov. Vsebina paketa pa je opisana v tabeli \ref{table:udp-command}.

\input{./Tabele/udp-command.tex}

Kontrolni bajt, referenèni navori ter hitrosti za posamezen motor se posredujejo naprej na krmilnik robota. Ostali bajti pa so namenjeni zagotavljanju varnosti med komunikacijo. Referenèni navori so v Nm, hitrosti pa v rad/s.

S prispelim UDP paketom strežnik pretvori dane navore in hitrosti v format, ki je naveden v dokumentaciji in opisan v \ref{sec:arc_drive}. Kontrolni bajti za posamezne motorje ostanejo nespremenjeni in se posredujejo enaki kot so prispeli. Strežnik prispele podatke zapakira v ARCNET paket naveden v tabeli \ref{table:arcnet-command}. Paket pošlje po ARCNET omrežju

\input{./Tabele/arcnet-command.tex}

Strežnik nato poèaka na odgovor servo krmilnika. Strežnik odgovor servo krmilnika najprej pretvori v želeno obliko. Hitrosti in navori v sklepih so ponovno zapisani v formatu navedenem v \ref{sec:arc_drive}. Te podatke pa nato zapakira v UDP paket. Zraven doda še kontrolne bajte. UDP paket poslan klientu je opisan v tabeli \ref{table:udp-reply}.

\input{./Tabele/udp-reply.tex}

Naloga strežnika je tudi zagotavljanje sinhronega delovanja. Strežnik daje takt komunikaciji. Za hitrost delovanja programa izbrali frekvenco pošiljanja paketov 500 Hz, ker je to malo manj kolikor je zgornja meja samega krmilnika. Med razvijanjem strežnika smo opravili analizo porabljenega èasa med posameznimi deli programa in ugotovili, da v povpreèju med poslanim ter prejetim ARCNET paketom poteèe 0.9 ms. S tem, da smo vzeli malo nižjo frekvenco kat je maksimalna mogoèa smo omogoèili nadaljnje razvijanje strežnika brez, da bi zgubil na frekvenci delovanja. 

Strežnik, potem ko prejme in pošlje vse podatke, èaka, da mine od zaèetka cikla toèno 2 ms. Ohranjanje frekvence èasovnega cikla je kritiènega pomena. Zato strežnik prekine komunikacijo s servo krmilnikom, v kolikor nov UDP paket ne prispe pravoèasno.

Diagram delovanja strežnika prikazuje slika \ref{fig:server-flowchart}.
\input{./Slike/server-flowchart.tex}

\subsection{Uporaba programa}

Kot povedano, je bil program narejen na Linux operacijskemu sistemu. Prednost tega sistema je tudi uporaba SSH (\textit{Secure Shell}) protokola za oddaljen dostop. Uporabnik lahko na ta naèin zažene strežnik brez, da je fizièno ob raèunalniku. 

Pred zagonom strežnika je potrebno najprej naložiti ARCNET modul v Linux jedro. To napravi uporabnik z zagonom skripte \verb|arcnet_ON|, ki smo jo pripravili (slika \ref{fig:linux-arcnetON}).
\input{./Slike/linux-arcnetON.tex}
Sledi zagon programa z ukazom \verb|./udparcnet-server <port>|. Gre za standardno Linux sintakso za zagon programov pri èemer \verb|./| pomeni zagon, \verb|udparcnet-server| ime programa, \verb|<port>| pa pomeni vrata na katerih bo strežnik poslušal po prispelih UDP paketih. Èe uporabnik želi na primer izbrati vrata 1337 to naredi tako: \verb|./udparcnet-server 1337|. Primer zaganjanja strežnika je na sliki \ref{fig:linux-success}.

Iz slike \ref{fig:linux-success} vidimo, da program javi, èe so bile funkcije v inicializacije uspešne in èe je senzor sil JR3 povezan. V kolikor senzorja ni, strežnik še vedno deluje, vendar so vrednosti poslanih sil enake 0.
\input{./Slike/linux-success.tex}



\subsection{Varnostni ukrepi}

V tabelah, ki opisujejo poslane in prejete UDP pakete je mogoèe razbrati, da so nekateri bajti namenjeni ohranjanju komunikacije oz. preverjanju ali le-ta sploh še poteka. Eden od takih ukrepov je, da v kolikor nov UDP ali ARCNET paket ne prispe v nekem vnaprej definiranem èasu (v našem primeru 1 s), program robota zaustavi nato pa gre v stanje èakanja novega paketa. Ta èas smo nastavili na eno sekundo.

Ko je program v èakanju, preverja prispele UDP pakete ali imajo pravilno štartno sekvenco. Na ta naèin poskrbimo, da se vodenje zaène z prvim prejetim UDP paketom in da v primeru prekinjene komunikacije se vodenje ne bi ponovno zaèelo izvajati sredi delovanja višjenivojskega vodenja.

Naslednji varnostni ukrep preverja stanje varnostnega gumba (\textit{Emegerncy stop}).  V kolikor se ta pritisne, se na servo krmilniku že sam po sebi sproži ukaz za ustavitev motorjev ter vklop zavor. Na strežniku pa se to pozna tako, da se program zaustavi. V kolikor želimo nadaljevati z vodenjem, je potrebno program ponovno zagnati.



\chapter{Vodenje robota PA-10} \label{chap:vodenje}

V prejšnjih poglavjih je bilo govora o pošiljanju referenènih hitrosti in navorov na krmilnik servo motorjev robota PA-10. V poglavju, ki sledi, pa bo govora o doloèanju teh krmilnih velièin za vodenja robota. V tem poglavju bo natanèneje opisano tudi vodenje robota v zunanjih koordinatah. Opisan bo postopek kompenzacije vpliva težnosti prijemala na senzor sile JR3. Na koncu pa bosta opisana dva naèina za vodenje robota v stiku z okolico, admitanèno vodenje ter vodenje preko inverzne dinamike.


\section{Kompenzacija mase prijemala ter merilnega odmika na senzorju sile JR3} \label{sec:vodenje-jr3}

Delovanje senzorja sile JR3 je bilo opisano v prejšnjih poglavjih. Senzor je pritrjen na vrh robota in meri navore ter sile, ki delujejo nanj v njegovem koordinatnem sistemu. Sile in navore na vrhu robota lahko preslikamo v koordinatni sistem baze preko matrike homogene transformacije

\begin{equation}
\mathbf{h}_b = \textbf{T}^0_{7} \mathbf{h}_e
\end{equation}

Robot brez prijemala v praksi ni pretirano uporaben saj lahko opravlja le malo uporabnih nalog, npr. premikanje objektov s porivanjem. V kolikor pa želimo, da bo robot lahko izvajal tudi druge naloge, je potrebno nanj pritrditi primerno prijemalo, ki ga pritrdimo na senzor. Ker ima prijemalo neko maso, bo na senzor delovala neka sila in navor kot posledica delovanja gravitacije. To pomeni, da bomo kljub temu, da senzor ni v kontaktu z okolico, izmerili neke sile. Izmerjene sile so napaka, ki se so posledica kontakta prijemala z okolico. Pri izmerjenih silah je potrebno še upoštevati merilni odmik, ki se pojavi kot posledica lezenja uporovnih mostièkov.

Sile ($\textbf{f}_s$) in navore ($ \boldsymbol{\tau}_s $), ki jih meri senzor, lahko razdelimo na tri komponente

\begin{equation}
    \begin{array}{r c l}
    \textbf{f}_s &=& \textbf{f}_{env} + \textbf{f}_{grav} + \textbf{f}_{off} \\
    \boldsymbol{\tau}_s &=& \boldsymbol{\tau}_{env} + \boldsymbol{\tau}_{grav} + \boldsymbol{\tau}_{off},
    \end{array}
\end{equation}
kjer z $(.)_{env}$ oznaèimo zunanje sile in navore, ki delujejo na senzor, z $(.)_{grav}$ vpliv mase prijemala, èleni oznaèeni z $(.)_{off}$ pa predstavljajo merilni odmik, ki je posledica lezenja senzorja. Da dobimo vrednosti sil, ki delujejo na vrh robota ($\textbf{f}_s$ in $ \boldsymbol{\tau}_s $), je potrebno kompenzirati vplive gravitacijskih sil prijemala in lazenja senzorja. V ta namen je potrebno identificirati maso in težišèe prijemala ter merilni odmik senzorja. Postopek, ki smo ga razvili, je sledeè.

Ko vrh robota ni v kontaktu z okolico velja $\textbf{f}_{env} = 0$ in $\boldsymbol{\tau}_{env} = 0$ oziroma:

\begin{equation}
\begin{array}{r c l}
\textbf{f}_{s} &=& \textbf{f}_{grav} + \textbf{f}_{off} \\
\boldsymbol{\tau}_{s} &=& \boldsymbol{\tau}_{grav} + \boldsymbol{\tau}_{off}.
\end{array}
\end{equation}

\input{./Slike/jr3_coordinatesistem.tex}


Sila $\textbf{f}_{grav} $ je odvisna od mase prijemala (\textit{m}), težišèa ter orientacije vrha robota. Predpostavimo lahko, da so koordinatni sistemi vrha robota, senzorja in prijemala enako orientirani. Orientacijo senzorja zapišemo s poznavanjem kinematiènega modela in bo v nadaljevanju oznaèena z \textbf{R}. Tako je mogoèe doloèiti  prispevek 

\begin{equation}\label{eq:fgravlong}
	\textbf{f}_{grav} = \textbf{R}
	\begin{bmatrix}
	0 \\
	0 \\
	mg
	\end{bmatrix} = \textbf{R} \textbf{f}_{gz}.
\end{equation}
Ker ima $ \textbf{f}_{gz} $ le en èlen razlièen od niè, lahko enaèbo (\ref{eq:fgravlong}) poenostavimo in dobimo

\begin{equation} \label{eq:short_r}
\textbf{f}_{grav} = 
\begin{bmatrix}
r31 \\
r32 \\
r33
\end{bmatrix}mg = (\textbf{R}_3 g)m,
\end{equation}
kjer je $ \textbf{R}_3 $ tretji stolpec matrike \textbf{R}.

Avtorji v \cite{omrcen_jr3} pokažejo, da je mogoèe izraèunati $\textbf{f}_{grav}$ in $\textbf{f}_{off}$ na podlagi najmanj dveh meritev ($\textbf{f}_{meas}^{(1)}$ in $\textbf{f}_{meas}^{(2)}$). Zapišemo sistem enaèb v matrièni obliki

\begin{equation}\label{eq:fmeas12}
\begin{bmatrix}	\textbf{f}_{mes}^{(1)} \\ \textbf{f}_{mes}^{(2)} \end{bmatrix} = \begin{bmatrix} \mathbf{R}^{(1)} & \textbf{I} \\ \mathbf{R}^{(2)} & \textbf{I}\end{bmatrix} \begin{bmatrix} \textbf{f}_{gz} \\\textbf{f}_{off} \end{bmatrix}.
\end{equation}
Upoštevaje (\ref{eq:short_r}) se nam enaèba (\ref{eq:fmeas12}) poenostavi na 
\begin{equation}\label{eq:fmeas12_short}
\begin{bmatrix}\mathbf{f}_{mes}^{(1)} \\ \mathbf{f}_{mes}^{(2)} \end{bmatrix} = \begin{bmatrix} \mathbf{R}_3^{(1)}g & \mathbf{I} \\ \mathbf{R}_3^{(2)}g & \mathbf{I}\end{bmatrix} \begin{bmatrix} m \\ \mathbf{f}_{off} \end{bmatrix} = \mathbf{A}  \begin{bmatrix} m \\\textbf{f}_{off} \end{bmatrix}.
\end{equation}
Izrazimo $\textbf{f}_{grav}$ in $\textbf{f}_{off}$

\begin{equation}
 	\begin{bmatrix}	\widehat{m} \\ \widehat{\textbf{f}}_{off} \end{bmatrix} = \begin{pmatrix} \textbf{A}^T \textbf{A}\end{pmatrix}^{-1} \textbf{A}^T \begin{bmatrix}	\textbf{f}_{meas}^{(1)} \\ \textbf{f}_{meas}^{(2)} \end{bmatrix}.
\end{equation}
Enaèba bo veljala le, èe bo matrika \textbf{A} polnega ranga oziroma, èe bosta meritvi linearno neodvisni.


Za navor pa je potrebno poznati tudi translacijski vektor od težišèa do koordinatnega sistema senzorja, v nadaljevanju oznaèen z \textbf{r}. Prispevek navora zaradi vpliva gravitacije je 
\begin{equation}\label{eq:taugrav}
\boldsymbol{\tau}_{grav} = \textbf{r} \times \textbf{f}_{grav}.
\end{equation}
Vektorski produkt bomo nadomestili z uporabo matriènega zapisa vektorja $\textbf{f}_{grav}$ kot
\begin{equation}
S(\mathbf{f}_{grav}) =
\begin{bmatrix}
0 & -{\mathbf{f}_{grav}}_z & {\mathbf{f}_{grav}}_y \\
{\mathbf{f}_{grav}}_z & 0 & -{\mathbf{f}_{grav}}_x\\
-{\mathbf{f}_{grav}}_y & {\mathbf{f}_{grav}}_x & 0
\end{bmatrix}
\end{equation} 
in enaèbo \ref{eq:taugrav} zapisalo kot
\begin{equation}
\boldsymbol{\tau}_{grav} = \textbf{S}(\textbf{f}_{grav}) \textbf{r}.
\end{equation}

Iz treh razliènih meritev navorov ($\boldsymbol{\tau}_{meas}^{(1)}$, $\boldsymbol{\tau}_{meas}^{(2)}$ in  $\boldsymbol{\tau}_{meas}^{(3)}$) pri treh razliènih orientacijah ($\textbf{R}_{meas}^{(1)}$, $\textbf{R}_{meas}^{(2)}$ in  $\textbf{R}_{meas}^{(3)}$) zapišemo sistem enaèb

\begin{equation}
\begin{bmatrix}	\boldsymbol{\tau}_{meas}^{(1)} \\ \boldsymbol{\tau}_{meas}^{(2)} \\ \boldsymbol{\tau}_{meas}^{(3)} \end{bmatrix} = \begin{bmatrix} \mathbf{S}(\mathbf{f}_{grav})^{(1)} & \textbf{I} \\ \mathbf{S}(\mathbf{f}_{grav})^{(2)} & \textbf{I} \\ \mathbf{S}(\mathbf{f}_{grav})^{(3)} & \textbf{I} \end{bmatrix} \begin{bmatrix}	\textbf{r} \\\boldsymbol{\tau}_{off}\end{bmatrix}
=\textbf{B}\begin{bmatrix}
\textbf{r} \\ \boldsymbol{\tau}_{off}
\end{bmatrix}
.
\end{equation}
Enaèbo obrnemo in izrazimo \textbf{r} ter $\boldsymbol{\tau}_{off}$

\begin{equation}
\begin{bmatrix}	\textbf{r} \\\boldsymbol{\tau}_{off}\end{bmatrix} = (\textbf{B}^T\textbf{B})^{-1}\textbf{B}^T \begin{bmatrix}	\boldsymbol{\tau}_{meas}^{(1)} \\ \boldsymbol{\tau}_{meas}^{(2)} \\ \boldsymbol{\tau}_{meas}^{(3)} \end{bmatrix}.
\end{equation}

Bistveni podatki, ki smo jih s temi izraèuni dobili, so ocenjeni merilni odmiki, $ \widehat{\mathbf{f}}_{off} $ in $ \widehat{\boldsymbol{\tau}}_{off} $ ter vpliv gravitacije, $ \widehat{\mathbf{f}}_{grav} = \textbf{R} \begin{bmatrix}0 & 0 & \widehat{m}g \end{bmatrix}^T $ in $ \widehat{\boldsymbol{\tau}}_{grav} = \textbf{S}(\widehat{\mathbf{f}}_{grav}) \widehat{\mathbf{r}}$.  Prednost tega postopka je, da imamo orientacijo senzorja v vseh merilnih pozicijah natanèno doloèeno zaradi poznavanja kinematiènega modela robota. Hkrati pa lahko ta postopek popolnoma avtomatiziramo, kar smo tudi naredili. Postopek je opisan v dodatku \ref{appendix:jr3-calibration}. Masa težišèe prijemala èasovno neodvisna parametra. Zaradi lezenja uporovnih listièev pa je merilni odmik èasovno odvisen in ga je potrebno pogosteje izmeriti.

V nadaljevanju bo sila ter navor kot posledica interakcije z okolico zapisana v vektorju $\textbf{h}_e$ kot
\begin{equation}
\textbf{h}_e =  \begin{bmatrix} \textbf{f}_{s} - \widehat{\textbf{f}}_{grav} - \widehat{\textbf{f}}_{off}\\ \boldsymbol{\tau}_s - \widehat{\boldsymbol{\tau}}_{grav} - \widehat{\boldsymbol{\tau}}_{off}\end{bmatrix} = \begin{bmatrix} \textbf{f}_{env} \\ \boldsymbol{\tau}_{env} \end{bmatrix},
\end{equation}
kjer so z $ (.)_s $ oznaèeni odèitki senzorja.

\section{Vodenje preko inverzne kinematike} \label{sec:admittheor}

Za vodenje robota preko hitrosti v sklepih krmilnik uporablja PI regulator, ki poskrbi, da se vsak sklep vrti s hitrostjo èimbolj podobno referenèni.  Predpostavimo lahko, da ne glede na konfiguracijo ter obremenitev robota, regulator zagotovi poskrbel konvergenco napake in stabilnost robota. V nadaljevanju bo opisano vodenje sklepov robota v želeno lego oziroma vodenje robota v notranjih koordinatah. Nato pa se bo iz tega še izpeljalo vodenje v zunanjih koordinatah.


\subsection{Vodenje v notranjih koordinatah} \label{sec:admit_inner}

Krmilnik servo motorjev v vsakem danem trenutku vraèa trenuten kot v sklepu. Lastnosti zaprtozanènega sistema so takšne, da lahko servo sistem ene stopnje robota aproksimiramo kot integrator. Naj bo referenèni kot v sklepih oznaèen kot $\textbf{q}_{ref}$ in naj bo dejanski kot oznaèen kot $\textbf{q}$. Razlika med njima je napaka v kotu 

\begin{equation}
	\tilde{\textbf{q}} = \textbf{q}_{ref} - \textbf{q}.
\end{equation}

S preprostim P regulatorjem lahko kote v sklepu robota vodimo s povratno zanko tako, kot je prikazano na shemi \ref{fig:qfeedback}
\begin{equation} \label{eq:p_reg_q}
\textbf{u} = \textbf{K}_p  \tilde{\textbf{q}}.
\end{equation}
Ojaèanje regulatorja je oznaèeno s $\textbf{K}_p$ in je diagonalna matrika saj ima vsak sklep svoje ojaèanje neodvisno od ostalih. S poveèevanjem ojaèanja regulatorja \textbf{K} vplivamo na dinamiko odziva \cite{zupancic_tr}.

%Primer odziva takega regulatorja pri K = 1 je na sliki \ref{fig:p-reg}.

%\input{./Slike/p-reg.tex}

\begin{figure}
	\input{./BlockDiagrams/vel_to_ang.tex}
	\caption{Povratna zanka za vodenje kota v sklepu}
	\label{fig:qfeedback}
\end{figure}


Iz blokovnega diagrama lahko zapišemo prenosno funkcijo sistema \textit{P(s)} in analiziramo stabilnost:

\begin{equation}
	P(s) = \frac{K \frac{1}{s}}{1+K \frac{1}{s}} = \frac{K}{s+K}
\end{equation}

Pogoj stabilnosti je, da vsi poli sistema ležijo na desni strani \textit{s} ravnine. V tem primeru je tako pogoj $ 0 > K > \frac{2}{T_s}$, kjer je $ T_s $ vzorèni èas (v našem primeru 0.002). 


\subsection{Vodenje v zunanjih koordinatah} \label{sec:inv_kin_x}

Kinematièni model robota in problem inverzne kinematike je bil opisan v \ref{sec:pa10_kin_model}. Predstavljen je bil problem inverzne kinematike za redundantni sistem ter pseudoinverz Jacobijeve matrike. Ker je robot PA-10 redundanten bo v nadaljevanju uporabljen generaliziran pseudoinverz Jacobijeve matrike.

Naj bo $\textbf{x}_{ref}$ vektor referenène lege vrha robota in naj bo $\textbf{x}$ trenutna lega vrha robota. Napaka je tako



\begin{equation} \label{eq:xerr}
\tilde{\textbf{x}} = \textbf{x}_{ref}  - \textbf{x}
\end{equation}

Enaèba direktne kinematike nam govori o odnosu med hitrostjo vrha robota ter hitrostjo v sklepih robota

\begin{equation} \label{eq:qtox}
\dot{\textbf{x}} = \textbf{J}(\textbf{q})  \dot{\textbf{q}}.
\end{equation}

To enaèbo je mogoèe razumeti tudi kot zvezo med spremembo položaja vrha ter sklepov robota \cite{mihelj_vodenje}. Zato je mogoèe to enaèbo uporabiti za zapis relacije med napako vrha ter potrebnim odmikov v sklepih preko preko enaèbe za inverzno kinematiko

\begin{equation} \label{eq:qerr}
	\tilde{\textbf{q}} = \textbf{J}^{*}(\textbf{q})  \tilde{\textbf{x}},
\end{equation}
ki pa velja le za majhne napake.

Z vstavitvijo enaèbe (\ref{eq:qerr}) v (\ref{eq:p_reg_q}) dobimo P regulator lege vrha robota.
\begin{equation} \label{eq:outcontrol}
\textbf{u} = \textbf{K}_p  \textbf{J}^{*}(\textbf{q})  (\textbf{x}_{ref} - \textbf{x}).
\end{equation}

Avtor v \cite{mihelj_vodenje} navaja, da se mehanski sistem, ki je voden na ta naèin, obnaša kot mehanski sistem z \textit{n} - dimenzionalno vzmetjo v notranjih koordinatah. Togost omenjene vzmeti pa doloèa ojaèanje $\textbf{K}_p$.

\begin{figure}
	\input{./BlockDiagrams/x_to_vel.tex}
	\caption{Bloèna shema vodenje referenène lege vrha robota}
	\label{fig:xfeedback}
\end{figure}



	


%*********************** INVERZNA DINAMIKA ********************************
\section{Vodenje z inverzno dinamiko} \label{chap:invdyn}

Navor proizveden v motorjih robota je linearno odvisen od toka, ki gre v motor. Krmilnik servo motorjev robota PA-10 uporablja P regulator toka za vodenje motorjev v navornem naèinu. Problem vodenja robota v zunanjih koordinatah se tako prevede v problem doloèevanja primernega navora za opravljanje naloge. Navore lahko izraèunamo s pomoèjo inverznega dinamiènega modela, kar zahteva dobro poznavanje dinamiènih parametrov. Dinamièen model je bil opisan v \ref{sec:pa10-dynmodel}.

Vodenje robota v navornem naèinu ima to prednost, da lahko podajnost celotnega mehanizma spreminjamo. Tako robot ni nujno podajen le na vrhu ob uporabi senzorja sil, temveè po celotni konstrukciji. Tak naèin vodenja omogoèa dobro interakcijo z okoljem ter s èlovekom.

V nadaljevanju bomo opisali vodenje po zunanjih in po notranjih koordinatah. Enaèbo (\ref{eq:din}) zapišemo drugaèe in sicer brez upoštevanja zunanjih sil na vrh manipulatorja, $\textbf{h}_o = 0$. Dodatno bomo vpeljali še novo velièino

\begin{equation}
	\textbf{n}(q,\dot{q}) = \textbf{C}(\textbf{q},\dot{\textbf{q}})  \dot{\textbf{q}} + \textbf{F}_f(\dot{\textbf{q}}, \textbf{q}) + \textbf{g}(\textbf{q}),
\end{equation}
ki združuje vse dinamiène vplive razen vpliva vztrajnosti. Sedaj zapišemo dinamièen model robota v skrajšani obliki

\begin{equation}\label{eq:tau_dyn}
\pmb{\tau}(\mathbf{\ddot{q}},\mathbf{\dot{q}},\textbf{q}) = \textbf{B}(\textbf{q})  \ddot{\textbf{q}} + \textbf{n}(\textbf{q},\mathbf{\dot{q}})
\end{equation}

\subsection{Vodenje v notranjih koordinatah}

Preden se lotimo vodenja v zunanjih koordinatah je najprej potrebno definirati vodenje robota po notranjih koordinatah. Vhodna velièina je navor zato bomo zapisali 

\begin{equation}\label{eq:taueqq}
	\pmb{\tau}(q,\dot{q},\ddot{q}) = \textbf{u}.
\end{equation}
Predpostavimo, da poznamo približen dinamièni model robota, t.j. ocenjeno matriko $\mathbf{\hat{B}}$ in vektor $\mathbf{\hat{n}}$. Navor za sledenje referenènemu pospešku $\mathbf{\ddot{q}}_{ref}$ sedaj izraèunamo z 

\begin{equation}\label{eq:u_from_ddq}
\textbf{u} = \mathbf{\hat{B}}(\textbf{q})\mathbf{\ddot{q}}_{ref} + \mathbf{\hat{n}}(q,\dot{q}).
\end{equation}
Vstavimo (\ref{eq:u_from_ddq}) in (\ref{eq:tau_dyn})  v (\ref{eq:taueqq}) in dobimo
\begin{equation}
\mathbf{\hat{B}}(\textbf{q})\mathbf{\ddot{q}}_{ref} + \mathbf{\hat{n}}(q,\dot{q}) = \textbf{B}(\textbf{q})  \ddot{\textbf{q}} + \textbf{n}(\textbf{q},\mathbf{\dot{q}}).
\end{equation}
Èe predpostavimo, da poznamo natanèen model, velja $\mathbf{\hat{B}} = \mathbf{B}$ in $\mathbf{\hat{n}} = \mathbf{n}$ in lahko zapišemo
\begin{equation}\label{eq:ddqref_ddq}
\mathbf{\ddot{q}}_{ref} = \ddot{\textbf{q}}.
\end{equation}
Enaèba nam pravi, da v kolikor poznamo natanèen dinamièen model, bo vodenje (\ref{eq:u_from_ddq}) zagotovilo želeno gibanje robota \cite{mihelj_vodenje}. Ker pa dinamiènih parametrov robota v praksni nikoli ne poznamo dovolj natanèno, (\ref{eq:ddqref_ddq}) ne velja in se pojavi napaka v poziciji sklepov. Zato je smiselno krmilnemu signalu dodati še regulacijo hitrosti ter pozicije in definiramo krmilne pospeške $ \ddot{\mathbf{q}}_u $ kot
\begin{equation}
	\ddot{\mathbf{q}}_u = \mathbf{\ddot{q}}_{ref} + \textbf{K}_p (\textbf{q}_{ref} - \textbf{q}) + \textbf{K}_d(\mathbf{\dot{q}}_{ref} - \mathbf{{q}}).
\end{equation}
in vstavimo $ \ddot{\mathbf{q}}_u $ v enaèbo (\ref{eq:u_from_ddq}) namesto $\pmb{\ddot{q}}_{ref}$. Konèna enaèba za vodenje preko inverzne dinamike je tako
\begin{equation}\label{eq:tq_in_coor}
	\textbf{u} = \mathbf{\hat{B}}(\textbf{q})(\mathbf{\ddot{q}}_{ref} + \textbf{K}_p (\mathbf{q}_{ref} - \textbf{q}) + \textbf{K}_d(\mathbf{\dot{q}}_{ref} - \mathbf{{q}})) + \mathbf{\hat{n}}(q,\dot{q}).
\end{equation}

Èe sedaj primerjamo $ \ddot{\mathbf{q}}_u $ z dejanskim pospeškom v sklepih lahko zapišemo dinamiko signala napake, kot

\begin{equation}
	\mathbf{\ddot{\tilde{q}}} + \mathbf{K}_d \mathbf{\dot{\tilde{q}}}  + \mathbf{K}_p \mathbf{\tilde{q}} = 0.
\end{equation}
Enaèbo lahko prevedemo v Laplace-ov prostor 
\begin{equation}
	s^2 + \textbf{K}_ds+\textbf{K}_p = 0
\end{equation}
in opazimo, da je to prenosna funkcija drugega reda. Sistem bo asimptotièno stabilen, èe sta $\textbf{K}_p$ in $\textbf{K}_d$ pozitivno definitni. Nesklopljenost sistema dobimo tako, da sta matriki diagonalni. Diagonalne èlene zapišemo v obliki $\textbf{K}_{p_{ii}} = \omega^2{n_{ii}}$ in $\textbf{K}_{d_{ii}} = 2\xi_i \omega_{n_{ii}}$ \cite{mihelj_vodenje}, kjer je $\omega$ lastna frekvenca in $\xi$ dušenje sistema drugega reda. Shema takega vodenja je prikazana na sliki \ref{fig:ddq_tau_dyn}.

\begin{figure}
	\centering
	\scalebox{.75}{\input{./BlockDiagrams/inv_dyn_q.tex}}
	\caption{Bloèna shema vodenja po notranjih koordinatah preko inverzne dinamike.}
	\label{fig:ddq_tau_dyn}
\end{figure}

\subsection{Vodenje v zunanjih koordinatah}

V \ref{sec:inv_kin_x} smo robota vodili po hitrostih v sklepih in je bilo zato potrebno definirati tudi hitrost vrha robota. Pri vodenju preko inverzne dinamike pa smo pokazali, da je potrebno definirati ustrezne pospeške. Tako je sedaj potrebno izpeljali takšen $\ddot{\mathbf{q}}_u$, da bo robot sledil referenènim pospeškom v zunanjih koordinatah. Z upoštevanjem relacije med hitrostmi v sklepih in hitrostmi na vrhu robota
\begin{equation}
\dot{\textbf{x}} = \textbf{J}(\textbf{q})  \dot{\textbf{q}}.
\end{equation}
in njenega odvoda
\begin{equation}
\ddot{\mathbf{x}} = \textbf{J}(\textbf{q})\ddot{\mathbf{q}} +  \dot{\mathbf{J}}(\mathbf{q})\dot{\mathbf{q}}.
\end{equation}
lahko definiramo krmilni signal
\begin{equation}\label{eq:accel_dyn}
	\ddot{\mathbf{q}}_u = \textbf{J}^* (\textbf{q})(\ddot{\mathbf{x}_u} - \dot{\mathbf{J}}(\textbf{q},\dot{\mathbf{q}})\dot{\mathbf{q}})
\end{equation}

Sedaj lahko definiramo regulator v zunanjih koordinatah $ \ddot{\mathbf{x}}_u $, ki bo dajal take pospeške v sklepih, da bo vrh robota sledil referenèni legi. Avtor v \cite{siciliano_robot} predlaga sledeè regulator pospeškov
\begin{equation}\label{eq:accel_dyn_ref}
	\ddot{\mathbf{x}}_u = \ddot{\mathbf{x}}_{ref} + \textbf{K}_d \dot{\tilde{\mathbf{x}}} + \textbf{K}_p \tilde{\mathbf{x}}
\end{equation}
Z vstavitvijo (\ref{eq:accel_dyn_ref}) v (\ref{eq:accel_dyn}) dobimo konèno enaèbo pospeškov v sklepih
\begin{equation}\label{eq:alpha_inv_dyn}
	\ddot{\mathbf{q}}_u = \textbf{J}^* (\textbf{q})(\ddot{\mathbf{x}}_{ref} + \textbf{K}_d \dot{\tilde{\mathbf{x}}} + \textbf{K}_p \tilde{\mathbf{x}} - \dot{\mathbf{J}}(\textbf{q},\dot{\mathbf{q}})\dot{\mathbf{q}}).
\end{equation}
Regulator zagotavlja konvergenco signala napake proti niè v stacionarnem stanju
\begin{equation}\label{eq:dyn_err}
	\textbf{K}_p \tilde{\mathbf{x}} = 0.
\end{equation}
Shema takega vodenja je prikazana na sliki \ref{fig:ddx_tau_dyn}.
\begin{figure}
	\centering
	\scalebox{.75}{\input{./BlockDiagrams/inv_dyn_x.tex}}
	\caption{Bloèna shema vodenja po zunanjih koordinatah preko inverzne dinamike.}
	\label{fig:ddx_tau_dyn}
\end{figure}

\section{Interakcija z okoljem}

Robotski mehanizmi so v veèini primerov med opravljanjem nalog v kontaktu z okolico. Vendar pa obstaja veliko takih nalog, kjer nas sila med okolico in robotom ne zanima, npr. pobiranje in odlaganje. So pa primeri nalog, ko so interakcijske sile kljuènega pomena. Primer take naloge je recimo brušenje površine ali pa interakcija s èlovekom. V nadaljevanju tega poglavja bomo opisali dva naèina vodenja robota v kontaktu z okolico, admitanèno ter impedanèno.

\subsection{Admitanèno vodenje} \label{sec:vodenje-admitance}

Robotski mehanizem PA-10 je industrijski robot s segmenti iz pretežno litega železa. Segmenti imajo relativno veliko maso, sklepi pa relativno visoko trenje. Lahko predpostavimo, da ima manipulator veliko lastno impedanco. Pojem mehanske impedance izvira iz analogije elektriène impedance. Iz tega izraza izvira tudi izraz za admitanèno vodenje robota. Tako vodenje je uporabno predvsem ob interakciji s èlovekom, saj se celoten robot giblje v skladu z gibanjem èloveške roke \cite{mihelj_hapt}. Predstavlja pa razmerje med silo (\textit{F}) in hitrostjo (\textit{v}).

\begin{equation}
Z(s) = \frac{F}{v} = ms + b + \frac{k}{s}
\end{equation}
oziroma razmerje med silo in pozicijo (\textit{x})

\begin{equation}
Z(s) = \frac{F}{x} = ms^2 + bs + k,
\end{equation}
kjer je \textit{m} masa, \textit{b} viskozno dušenje, \textit{k} togost \cite{mihelj_hapt}.



Za admitanèno vodenje je potrebno upoštevati še podatek o silah in navorih, ki delujejo na vrhu robota. Izmerjene sile in navori bodo oznaèene s $\textbf{h}_{e}$, referenène sile in navori pa z $\textbf{h}_{ref}$. Napaka sile je tako definirana kot:
\begin{equation} \label{eq:herr}
\tilde{\textbf{h}} = \textbf{h}_{ref} - \textbf{h}_e.
\end{equation}

Sila kot rezultat delovanja robota na okolico je odvisna od hitrosti oz. pozicije vrha robota. Zato lahko napako sile dodamo v regulator lege (\ref{eq:outcontrol}) tako, da definiramo referenèno pozicijo v odvisnosti od sile

\begin{equation} \label{eq:xrefforce}
\textbf{x}_{ref} = \textbf{K}_{hP}\tilde{\textbf{h}} + \textbf{K}_{hI} \int_{0}^{t}\tilde{\textbf{h}}d\xi.
\end{equation}

Z vstavitvijo enaèbe (\ref{eq:xrefforce}) v (\ref{eq:outcontrol}) je mogoèe zapisati celotno regulacijsko enaèbo za vodenje robota v zunanjih koordinatah z upoštevanjem delovanja zunanjih sil na vrh robota.

\begin{equation} \label{eq:admitcontrol}
\textbf{u} = \textbf{K}_p  \textbf{J}^{*}(\textbf{K}_{hP}\tilde{\textbf{h}} + \textbf{K}_{hI} \int_{0}^{t}\tilde{\textbf{h}}d\xi - \textbf{x})
\end{equation}

\begin{figure}
	\centering
	\scalebox{.75}{\input{./BlockDiagrams/x_admitance_control.tex}}
	\caption{Bloèna shema admitanènega vodenja.}
	\label{fig:x_admitance_control}
\end{figure}

Dobili smo PI regulator sile interakcije. Èeprav je bilo pri definiciji mehanske impedance definirano, da je to razmerje med silo ter hitrostjo, se raje uporablja razmerje med silo ter pozicijo. Meritve sile so podvržene šumu, integrator pa deluje kot nizkopasovni filter. Shema vodenja je prikazana na sliki \ref{fig:x_admitance_control}.

Admitanèno vodenje se uporablja takrat, ko lahko robota vodimo le hitrostno ali pozicijsko in želimo vplivati na okolico z neko silo. Silo interakcije pa je doloèimo z modelom okolja. Kontakt si lahko predstavljamo kot interakcijo med togim robotom in podajnim okoljem.


\subsection{Impedanèno vodenje}

Pri izpeljavi vodenja lege robota z inverzno dinamiko smo predpostavili, da so sile interakcije $\textbf{h}_o$ enake niè. Ker pa to v primeru, da je robot v kontaktu z okoljem ni res, je potrebno pogledati kaj se zgodi takrat, ko te sile delujejo na robota. Vrh robota bo z neko silo deloval na okolje, ki pa jo lahko s senzorjem na vrhu robota oz. med prijemalom in vrhom, izmerimo. Vzemimo spet dinamièen model robota, ki ga vodimo preko reguliranega pospeška $\ddot{\mathbf{x}}_u$ in dodamo silo interakcije 
\begin{equation}\label{eq:dyn_outer_force}
\textbf{u}= \mathbf{\hat{B}}(\textbf{q}) \ddot{\mathbf{q}}_u + \mathbf{\hat{n}}(q,\dot{q}) + \mathbf{J}^T \mathbf{h}_o.
\end{equation}
Vidimo, da bodo sedaj navori v sklepi razlièni od izraèunanih preko inverznega dinamiènega modela in posledièno bo med želeno pozicijo vrha robota in dejansko pozicijo vrha robota nastala napaka. 

Za izhodišèe vzamemo enaèbo (\ref{eq:dyn_err}) in (\ref{eq:dyn_outer_force}) ter zapišemo dinamiko napake z upoštevanjem delovanja zunanjih sil

\begin{equation}
\ddot{\mathbf{x}}_{ref} + \textbf{K}_d \dot{\tilde{\mathbf{x}}}  + \textbf{K}_p \tilde{\mathbf{x}} = \textbf{B}_A^{-1}\textbf{h}_o,
\end{equation}
kjer je $ B_A $ analitièna vztrajnostna matrika.

Èe želimo napako kompenzirati je potrebno v regulator vkljuèiti še podatek o izmerjenih silah na vrhu robota ($ \textbf{h}_e $). Na ta naèin dosežemo to, da se vrh robota obnaša kot neskonèno tog sistem glede na vpliv zunanjih sil \cite{siciliano_robot}. To pomeni, da èe vodimo robota pozicijsko in pritisnemo na njegov vrh, bo kompenziral nastalo napako.

Zapišemo sedaj celotno enaèbo, ki opisuje navore v sklepih pri impedanènem vodenju

\begin{equation}\label{eq:u_impendance_control}
\textbf{u}= \mathbf{\hat{B}}(\textbf{q}) \textbf{J}^* (\textbf{q})(\ddot{\mathbf{x}}_{ref} + \textbf{K}_d \dot{\tilde{\mathbf{x}}} + \textbf{K}_p \tilde{\mathbf{x}} - \dot{\mathbf{J}}(\textbf{q},\dot{\mathbf{q}})\dot{\mathbf{q}} + \textbf{h}_e) + \mathbf{\hat{n}}(q,\dot{q}) + \mathbf{J}^T \mathbf{h}_o.
\end{equation}
Shema takega vodenja je prikazana na sliki \ref{fig:impedance_control}.
\begin{figure}[!h]
	\centering
	\scalebox{.6}{\input{./BlockDiagrams/impendance_control.tex}}
	\caption{}
	\label{fig:impedance_control}
\end{figure}

Impedanèno vodenje se uporablja takrat, ko lahko robota vodimo preko vhodnih navorov. Z razliko od admitanènega vodenja, si lahko kontakt predstavljamo kot interakcijo med zelo togo okolico in podajnim robotom. Podajnost robota pa je odvisna od parametrov vodenja $ (\textbf{K}_p, \textbf{K}_d) $ in kompenzacije sile.


%*********************** SIMULINK KNJIŽNICE ********************************
\chapter{Implementacija} \label{chap:implementacija}

Poznavanje teoretiènih osnov za vodenje robotov nam omogoèa realizacijo vodenja na naèin, ki je najbolj primeren zadani nalogi. V prejšnjem poglavju so bile te osnove opisane in prikazane so bile blokovne sheme vodenja. Iz tistih shem, je videti, da je za implementacijo razliènih vodenj potrebno poznati razlièno kolièino parametrov. Hitrostno vodenje je enostavnejše, saj je potrebno doloèiti le parametre ojaèanj regulatorja. Pri navornem vodenju robota pa doloèitev parametrov še zdaleè ni enostaven problem, saj je potrebno poznati dinamiène parametre samega robota.

V nadaljevanju tega poglavja, bo opisana implementacija algoritmov vodenja, ki so bili opisani v poglavju \ref{chap:vodenje}. Implementacija vodenj je hkrati tudi preizkus s katerim se bo ovrednotilo razviti UDP-ARNCET strežnik, ki je bil opisan v poglavju \ref{chap:udp-arcnet-server}. Za komunikacijo s strežnikom je bilo narejeno visokonivojsko vodenje v programskem paketu \matsim. Razlogi za izbiro omenjenega programskega paketa so bile dobre predhodne izkušnje ter dobro poznavanje delovanja programa s strani avtorjev. \simulink \space bloki, ki smo jih uporabili, bodo v nadaljevanju prikazani na slikah in podrobneje opisani v dodatku \ref{appendix:simulink-block}. Programski paket ponuja tudi uporabo èasovno kritiènega operacijskega sistema \rtsim. Ta sistem smo uporabili kot klienta, na katerega smo naložili program za višjenivojsko vodenje robota. Slika \ref{fig:simulink_vel_tq_control} prikazuje \simulink bloèni shemi za vodenje po hitrostih in navorih v prostoru naloge. Blok imenovan "\textit{Task Controller} bo za razlièna vodenja posebej predstavljen.

\input{./Slike/simulink_vel_tq_control.tex}

Namen poskusov je bil ovrednotiti razviti strežnik. Pokazati smo želeli, kako je višanje frekvence delovanja vplivalo na uspešnost vodenja. V ta namen, samo razvili še testni strežnik in klienta, ki delujeta s tako frekvenco kot je deloval MHI krmilnik t.j. s frekvenco vzorèenja 100 Hz. Z obema strežnikoma smo izvedeli enake poskuse vodenja robota in sicer:

\begin{enumerate}
	\item odziv na stopnièasti referenèni signal pozicije v notranjih koordinatah,
	\item odziv na referenèni signal pozicije v obliki rampe v zunanjih koordinatah.
\end{enumerate}
Vsi poskusi so bili izvedeni s hitrostnim in z navornim vodenjem.
	
Stopnièasti signal je bil izbran zato, da smo doloèili najprimernejše ojaèanje P regulatorja, ki zagotovi, da regulirani signal nima prenihaja. Dodatno smo s tem poskusom lahko opazovali tudi kakšna je zakasnitev v komunikaciji. Z višjimi vzorènimi èasi se lahko doseže veèja ojaèanja in posledièno tudi hitrejše odzive. 

Odziv na signal rampe v zunanjih koordinatah smo izbrali zato, da vidimo, kako dobro vrh robota sledi spreminjajoèi se referenci. Predpostavili smo, da bo ob zaèetku ter zakljuèku rampe vrh imel nekaj pogreška, nato pa bo konvergiral proti referenci.


Ovrednotili smo tudi vodenje robota v kontaktu z okolico tako pri hitrostnem (admitanènem) kot tudi pri navornem (impedanènem) vodenju. V kontaktu z okolico je bil referenèni signal oblikovan tako, da je robot deloval z želeno silo na podlago. Pri poskusu je bil robot v kontaktu s togo podlago in želena kontaktna sila je bila hipna (stopnièast signal).

\section{Hitrostno vodenje}

Implementacija hitrostnega vodenja robota je potekala postopoma. Najprej smo realizirali pozicijsko vodenje sklepov, sledilo je vodenje v zunanjih koordinatah, na koncu pa smo realizirali še admitanèno vodenje z vhodno referenèno silo. 


\input{./Slike/follow_step.tex}

\subsection{Vodenje brez kontakta}

\input{./Slike/notranje_koordinate_vel.tex}

Za pozicijsko vodenje sklepov smo uporabili regulator (\ref{eq:p_reg_q}). Bloèna shema vodenja je je podana na sliki \ref{fig:notranje_koordinate_vel}. Odzivi na stopnièasto spremembo referenène pozicije sklepov so prikazani na sliki \ref{fig:follow_step}. Iz grafov lahko opazimo, da lahko z vzorèno frekvenco 500 Hz uporabimo veèja ojaèanja za doseganje želenih odzivov. Pri ojaèanju $ K_p = 13 $ doseže sklep 98\% referenène vrednosti v 0.40 sekunde, z vzorèno frekvenco pa je $ K_p = 10 $ in doseže 98\% referenène vrednosti v 0.47 sekunde. 

\input{./Slike/zunanje_koordinate_vel.tex}
Za vodenje robota v zunanjih koordinatah po izbrani trajektoriji smo uporabili regulacijski zakon (\ref{eq:outcontrol}) z dodano referenèno hitrostjo pozicije
\begin{equation} \label{eq:outcontrol_ff}
	\textbf{u} =  \textbf{J}^{*}(\textbf{q})(\textbf{K}_p\mathbf{\tilde{x}}_{ref} + \mathbf{\dot{x}}_{ref}),
\end{equation}
ki zagotavlja boljše sledenje referenci. Bloèna shema takega vodenja je podana na sliki \ref{fig:follow_ramp_vel}.

\input{./Slike/follow_ramp_vel.tex}

Slika \ref{fig:follow_ramp_vel} prikazuje odzive vrha robota pri sledenju trapeznemu signalu želene pozicije v sklepu, kjer se želena hitrost v sklepu spremeni hipoma. Opaziti je odstopanje od reference ob spremembi hitrosti. Amplituda napake je proporcionalna s pospeškom, saj robot ne mora v trenutku pospešit na želeno hitrost zaradi dinamiènih lastnosti. Zato je tudi pri veèji spremembi hitrosti napaka veèja. Pri tem poskusu so bila ojaèanja empirièno nastavljena do zadovoljivih odzivov pri 500 Hz. Pri poskusu s 100 Hz smo uporabili enaka ojaèanja kot pri 500 Hz. Videti je, da pri manjši vzorèni frekvenci vrh robota bolj zaniha.




\subsection{Admitanèno vodenje}
\input{./Slike/pa10jr3.tex}

\input{./Slike/admitance_control.tex}
Za admitanèno vodenje robota smo uporabili regulacijski zakon (\ref{eq:admitcontrol}). Bloèna shema vodenja je prikazana na \ref{fig:admitance_control}. Robot je pritiskal na leseno površino, ki je bila zaradi varnosti postavljena na tršo spužvo, kot je prikazano na sliki \ref{fig:pa10jr3}. Na ta naèin smo dosegli, da je robot pritiskal na objekt z relativno trdo površino. Ob zaèetku vsakega poskusa je robot vrh robota bil blizu objekta, vendar se ga ni dotikal.

Rezultati poskusa za sledenje stopnièasti referenci so prikazani na sliki \ref{fig:admitance_step}. Najprej smo doloèili ojaèanja regulatorja za vodenje z vzorèno frekvenco 500 Hz ter opravili poskus. Poskus smo z enakimi ojaèanji ponovili z vzorèno frekvenco 100 Hz. Na grafih je videti, da je je vodenje pri frekvenci 500 Hz še stabilno pri vodenju s 100 Hz pa veè ne. S tem, da smo ojaèanja postili enaka smo lahko pokazali kako moèno je stabilnost vodenja v kontaktu z okolico odvisna od vzorène frekvence.

\input{./Slike/admitance_step.tex}


\section{Navorno voodenje}

Navorno vodenje zahteva poznavanje dinamiènega modela robota, zato je bilo potrebno najprej definirati dinamiène parametre. Robot PA-10 je precej razširjen in nekateri raziskovalci so te parametre že identificirali \cite{voung_pa10,aalst_pa10,rodrigo_pa10,petric_nevronska}, zato smo uporabili njihove parametre, razen parametrov za model trenja, ki smo jih identificirali sami, saj se lahko z obrabljenostjo, gretjem ter èasom spreminjajo.

Dinamièni model, ki smo ga za uporabljali poskuse, je zgradil \cite{petric_nevronska} z uporabo orodja \textit{STFAST}. Avtor je za dinamièni model uporabil podatke o masah zapisani v tabeli \ref{table:grav_params}. Matrike vztrajnosti za vsak sklep so aproksimirane z diagonalnimi matrikami, kjer so nenièelni èleni enaki 0,1. Za kompenzacijo trenja smo uporabili parametre, ki smo jih identificirali sami. Ker krmilnik robota PA-10 sprejema referenène navore v motorjih, smo morali preraèunane navore v sklepih iz dinamiènega modela pomnožiti s faktorjem prestave zobnikov. Pri kompenzaciji trenja to ni bilo potrebno, saj je identifikacija parametrov potekala z meritvijo navorov v motorjih.
\input{./Tabele/grav_params.tex} 

Izvedba vodenja je potekala postopoma. Tako kot pri hitrostnem vodenju smo najprej opravili poskus s stopnièasto referenco v notranjih koordinatah, sledil je poskus na signal rampe v zunanjih koordinatah, na koncu pa smo še preverili delovanje impedanènega vodenja.


\subsection{Kompenzacija trenja}

Za dobro navorno vodenje je nujno potrebna kompenzacija trenja. Avtorji v  \cite{bompos_pa10} predlagajo izboljšan Stribeckov model. Navor kot posledica trenja je tako aproksimiran s funkcijo
\begin{equation}
	\tau(\dot{q}) = f_1\dot{q} + f_2 \mathrm{sign}(\dot{q}) - f_3\mathrm{sign}(\dot{q})e^{-\frac{|\dot{q}|}{f_4}} - f_5 \mathrm{sign}(\dot{q})e^{-\frac{1}{f_6}}.
\end{equation}
\input{./Slike/friction_measure.tex}

Parametre $ f_1 \dots f_6 $ smo identificirali z eksperimentom. Ker krmilnik robota v vsakem trenutku vraèa navor, ki ga daje na motorje, smo robota vodili hitrostno in opazovali, kakšen navor proizvaja v sklepih. Pri tem eksperimentu smo morali robota postaviti v tako konfiguracijo, da gravitacija ni imela vpliv na navor v sklepih. Slika \ref{fig:friction_measure} prikazuje navore v odvisnosti od hitrosti. Iz pridobljenih podatkov smo s pomoèjo \matlab   funkcije za optimizacijo identificirali parametre Stribeckovega modela za vsak sklep razen za drugega. Ker je bila baza robota pritrjena na tla nismo morali postaviti robota v tako konfiguracijo, da gravitacija ne bi imela vpliva na navor proizveden v drugem sklepu, kar je tudi vidno na grafu \ref{fig:friction_measure_2}. Za ta sklep smo parametre doloèili empirièno. Identificirani parametri so zapisani v tabeli \ref{table:friction_params}.
\input{./Tabele/friction_params.tex}


\subsection{Vodenje brez kontakta}

\input{./Slike/torque_follow_step.tex}

\input{./Slike/notranje_koordinate_tq.tex}

Za izvedbo poskusa za odziv na signal stopnice smo uporabili regulacijski zakon \ref{eq:tq_in_coor}. Bloèna shema vodenja je prikazana na sliki \ref{fig:notranje_koordinate_tq}. Slika \ref{fig:torque_follow_step} prikazuje graf odziva tretjega sklepa na stopnièasto referenco. Podobno kot pri hitrostnem vodenju smo pri višjih vzorènih frekvencah lahko uporabili tudi veèja ojaèanja. Vendar pa je v primeru navornega vodenja razlika v ojaèanjih veèja. S frekvenco vzorèenja 100 Hz smo z ojaèanjem $K_p = 10$ dosegli 98\% referenène vrednosti v 0.24 sekunde. S frekvenco vzorèenja 500 Hz pa je bilo izbrano ojaèanje $K_p = 21$  in èas vzpona 0.184 sekunde.

Pri obeh frekvencah lahko opazimo, da pri premajhnih ojaèanjih regulirana velièina sploh ne doseže referenène vrednosti. Razlog je ne dovolj natanèno kompenzirano trenje. Vhodni navor je manjši kot je potreben za premagati silo trenja.


\input{./Slike/follow_ramp_tq.tex}

\input{./Slike/zunanje_koordinate_tq.tex}
Graf na sliki \ref{fig:follow_ramp_tq} prikazuje odziv vrha robota na sledenje signalu rampe pri dveh razliènih hitrostih v navornem naèinu. Za vodenje je bila uporabljena bloèna shema na sliki \ref{fig:zunanje_koordinate_tq} Za poskus so bila ojaèanja nastavljena pri vzorèni frekvenci 500 Hz nato pa so bila enaka ojaèanja uporabljena pri vzorèni frekvenci 100 Hz. Na grafu odzivov pri 500 Hz ter 100 Hz se pojavi odstopanje od referenène lege v ustaljenem stanju. Razlog za to je ne tako dobro kompenzirano trenje. Kljub temu, da je v ustaljenem stanju napaka, je krmilni signal premajhen, da bi premagal trenje v sklepih. Dodatno lahko opazimo, da je pri nižji vzorèni frekvenci napaka v ustaljenem stanju veèja ter vsebuje dodatne oscilacije.

Ker je kvaliteta navornega vodenja pogojena z dobrim poznavanjem dinamiènega modela se vsako odstopanje modela pokaže kot napaka v sledenju ter slabšanje stabilnosti. Dodatna težava, ki se nam je pojavila je bila, da krmilnik robota PA-10 sam po sebi ne vraèa trenutnih hitrosti v sklepih in smo jih zato morali raèunati, uporabili smo Kalmanov filter \cite{simulink_kalman}. Za boljše sledenje bi bilo potrebno uporabiti bolj natanèen dinamièen model in kvalitetnejši hitrostni signal.

\subsection{Impedanèno vodenje}

Za impedanèno vodenje smo uporabili regulacijski zakon \ref{eq:u_impendance_control} s tem, da smo $ \textbf{h}_e $ zamenjali z $ \textbf{K}_{hp}(\textbf{h}_{ref} - \textbf{h}_e) $ za vodenje po referenèni sili. Shema vodenja je prikazana na sliki \ref{fig:impedance_control_sim}.
\input{./Slike/impedance_control.tex}

Tako kot pri admitanènem vodenju smo tudi pri impedanènem vodenju napravili poskus na signalu stopnice vendar je bila tokrat amplituda stopnice 10 N. Odziv prikazuje graf na sliki \ref{fig:follow_step_impedance}. Odziv ima podobno kot pri admitanènem vodenju relativno velik prenihaj. Bistvena razlika pri tem vodenju pa je, da napaka nikoli ne konvergira proti niè. Razlog je podoben, kot smo ga navedli pri vodenju v zunanjih koordinatah z uporabo dinamiènega modela. Kljub temu, da je napaka razlièna od niè, je regulirni signal premajhen, da bi premagal silo trenja. Poskus smo opravili le pri vzorèni frekvenci 500 Hz, saj smo že pri admitanènem vodenju opazili nestabilnost pri manjšanju frekvence in bi pri admitanènem vodenju prièakovali podoben ali slabši odziv. 
\input{./Slike/impedance_step.tex}

\section{Analiza rezultatov}

Poskusi, ki so temeljili na razliènih naèinih vodenja so nam pokazali lastnosti razvitega strežnika, kvaliteto regulacijskih shem ter kvaliteto uporabljenega dinamiènega modela. Pomembna lastnost strežnika, ki deluje v korist vodenju, je visoka vzorèna frekvenca, kar omogoèa veèja ojaèanja ter hitrejše odzive. Pomembno pa je tudi opozoriti na zakasnitev v komunikaciji med klientom ter strežnikom, ki pa slabša kvaliteto vodenja. Mrtvi èas je prikazan na sliki \ref{fig:follow_step_vel_zoom}. Zakasnitev v komunikaciji med klientom in strežnikom je 0.08 s kar predstavlja 4 vzorce. Razlog za zakasnitev je lahko uporabljeno stikalo (\textit{ang. switch}) v mreži ali pa delovanje klienta. Pri hitrostnem vodenju brez kontakta okolice ta zakasnitev ne predstavlja veèjih težav v stabilnosti. Pri vodenju z okolico ter na podlagi inverzne dinamike pa jo. Zakasnitev se bo v nadaljnjem delu poskušalo odpraviti.
\input{./Slike/follow_step_vel_zoom.tex}

Pri vodenju z uporabo inverzne dinamike pa bo potrebno razviti oz. doloèiti dinamièni model in njegove parametre bolj natanèno. Najveèji poudarek bo na èlenih matrik vztrajnosti ter kompenzaciji trenja. Vztrajnost vpliva na kvaliteto vodenja ko nastopijo veèji pospeški, kompenzacija trenja pa takrat, ko želimo robota voditi z nizko hitrostjo. Hkrati pa je potrebno tudi opozoriti na problem signala hitrosti, ki ga krmilnik motorjev sam po sebi ne vraèa in ga je zato potrebno izraèunati. V delu smo uporabili Kalmanov filter, saj bi odvod kota bil preveè ošumljen in bi to slabo vplivalo na vodenje. Z uporabo Kalmanovega filtra na klientovi strani smo uporabili že tako zakasnjen signal pozicije sklepov za izraèun kotne hitrosti, kar pomeni, da je bil signal hitrosti še dodatno zakasnjen, kar tudi slabo vpliva na kakovost vodenja. V nadaljnjem delu bi bilo potrebno implementirati dober izraèun hitrosti že na samem strežniku.

%*********************** ZAKLJUÈEK ********************************
\chapter{Zakljuèek} \label{chap:zakljucek}

V delu smo avtorji predstavili  na novo razviti krmilnik za robota PA-10, ki deluje kot strežnik ter ovrednotili njegovo delovanje. V ta namen smo z uporabo razvitega strežnika realizirali razliène naèine vodenja robota in z eksperimenti pokazali zadovoljivo delovanje strežnika in opozorili na njegove pomanjkljivosti. 

Opazili smo, da vodenje robota preko vhodnih hitrostih dela prièakovano in zadovoljivo, dokler se referenca ne spreminja s preveliko hitrostjo, za kar smo tudi predstavili rešitev v obliki v naprej zakljuèene zanke. Tudi admitanèno vodenje preko referenène sile se je izkazalo kot dobro s hitrim odzivom in kratkim umiritvenim èasom. Sicer je pri admitanènem vodenju bilo nekaj prenihaja, ki bi ga lahko z zmanjševanjem ojaèanj zmanjšali, vendar bi izgubili hiter odziv.

Navorno vodenje robota se je z danim dinamiènim modelom izkazalo kot nezadovoljivo. Odziv na stopnico je bil sicer hitrejši vendar pa napaka ni konvergirala proti niè. Sledenje referenèni trajektoriji v zunanjih koordinatah je imelo veèjo napako kot pri hitrostnem vodenju. Razlogi za to so ne dovolj natanèni parametri v dinamiènem modelu.

S poskusi smo pokazali, da je razviti strežnik hitrejši in omogoèa boljše vodenje v primerjavi s strežnikom, ki bi deloval z manjšo frekvenco. Integracija senzorja sil in navorov JR3 v strežnik omogoèa implementacijo admitanènega in impedanènega vodenje, kar s prejšnjim krmilnikom ni bilo mogoèe. 

Nadaljnje delo predvideva razviti dinamièen model z izboljšanimi parametri za boljše vodenje v navornem naèinu. Predvsem se bo izboljšalo parametre za kompenzacijo trenja tako, da dobro delovalo tudi pri nizkih hitrostih. Na ta naèin se bo doseglo dobro konvergenco napake proti niè.

%**************** LITERATURA **********************
\bibliographystyle{ieeetrslo}
\bibliography{literatura}

%**************** PRILOGE ************************


\appendix
\chapter{Avtomatska identifikacija parametrov teže prijemala} \label{appendix:jr3-calibration}

Program za identifikacijo prijemala je nastal v okolju \matlab in se ga uporablja preko vmesnika, ki je na sliki \ref{fig:jr3_calibration}. Program deluje tako, da robota najprej spravi v izhodišèno konfiguracijo sklepov in nato zaène obraèati 5. in 6. sklep. Program postavi prijemalo v tri razliène orientacije, ki so med seboj ortogonalne. Vsako lego drži vsaj toliko èasa, dokler ne dobi zadostnega števila odèitkov iz senzorja. Ko opravi meritve v treh razliènih legah izraèuna parametre prijemala za kompenzacijo njegove teže ter merilni odmik senzorja. 

\input{./Slike/jr3_calibration.tex}

\chapter{\simulink blok PA-10 CONTROL} \label{appendix:simulink-block}

\input{./Slike/simulink-pa-10.tex}

Simulink knjižnica, ki je nastala za uporabljanje robota PA-10 v \matsim je prikazana na sliki \ref{fig:simulink-pa-10}. Blok ima 4 vhode ter 5 izhodov. Vhodi v blok so po vrsti:
\begin{itemize}
	\item izbira med navornim ali hitrostnim naèinom vodenja,
	\item referenèni navori v motorjih,
	\item referenène hitrosti sklepov,
	\item dodatni/rezervirani bajti.
\end{itemize}
Za izbrati hitrostni naèin vodenja, moramo na prvi vhod dati vrednost $ 0 $, za navorni naèin pa vrednost $ 1 $. Ta signal se lahko spremeni sproti med delovanjem programa. Vhoda za referenène navore ter hitrosti sprejmeta podatke v obliki vektorja s sedmimi elementi, za vsak sklep posebej. Dodatni bajti zaenkrat še niso v uporabi, vendar se lahko strežnik po potrebi prilagodi.

Izhodi po vrsti pa so 
\begin{itemize}
	\item statusni bajti posameznih servo motorjev,
	\item trenutni koti v sklepi,
	\item trenutni navor na motorjih,
	\item odèitki senzorja sil in navorov JR3,
	\item ciklièni èas strežnika.
\end{itemize}

Vsebina statusnih bajtov je bila opisana v \ref{sec:arc_drive}. V \simulink shemi lahko te podatke izkoristimo za spremljanje delovanja motorjev. Primer uporabe je, zaustavitev \simulink programa v primeru pritiska varnostnega stikala robota. 

Blok vsebuje še nekaj varnostnih mehanizmov, ki v primeru prekinitve komunikacije simulacijo vstavijo in so vidni na sliki \ref{fig:simulink-pa-10-inside}. Preverja tudi kakšen je cikel izvajanja programa na klientovi strani in v primeru, da preseže èas dveh vzorcev se izvajanje programa prekine.

\input{./Slike/simulink-pa-10-inside.tex}

%\chapter{Dodatek 3} \label{dodatekC}
%
%
%\begin{verbatim}
%There is no spoon.
%\end{verbatim}
%\normalsize



\end{document}
